{% extends "base.html" %}

{% block content %}
<style>
    /* --- TEMA VISUAL: NEXUS 1 STYLE --- */
    :root {
        --sidebar-bg: #2c3e50;
        --sidebar-width: 280px;
        --header-height: 60px;
        --primary-accent: #3498db;
        --bg-body: #f4f6f9;
        --text-dark: #333;
        --text-light: #ecf0f1;
        --border-color: #dee2e6;
        --folder-icon-color: #f1c40f;
    }

    body {
        background-color: var(--bg-body);
        font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
        overflow: hidden; /* Importante para el layout tipo App */
    }

    /* --- LAYOUT PRINCIPAL FLEXBOX --- */
    .app-container { 
        display: flex; 
        height: 100vh; /* Ocupa el 100% del viewport real */
        height: 100dvh; /* Dynamic viewport height para móviles modernos */
        width: 100vw; 
        overflow: hidden;
    }

    /* --- SIDEBAR (PC) --- */
    .sidebar {
        width: var(--sidebar-width);
        background-color: var(--sidebar-bg);
        color: var(--text-light);
        display: flex; flex-direction: column;
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 1050; flex-shrink: 0;
        height: 100%;
    }

    .sidebar-brand {
        padding: 15px 20px;
        background-color: rgba(0,0,0,0.2);
        border-bottom: 1px solid rgba(255,255,255,0.1);
        flex-shrink: 0;
    }
    .brand-title { font-weight: 700; font-size: 1.2rem; letter-spacing: 0.5px; }
    .brand-subtitle { font-size: 0.7rem; opacity: 0.7; font-family: monospace; }

    .sidebar-menu { 
        flex-grow: 1; 
        overflow-y: auto; /* Scroll independiente para el menú */
        padding-top: 10px;
        scrollbar-width: thin; /* Firefox */
        scrollbar-color: rgba(255,255,255,0.2) transparent;
    }

    .nav-header {
        font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
        color: rgba(255,255,255,0.4); padding: 20px 20px 5px 20px; font-weight: 700;
    }

    .nav-item {
        padding: 12px 20px; color: #bdc3c7; text-decoration: none;
        display: flex; align-items: center; border-left: 3px solid transparent;
        cursor: pointer; transition: all 0.2s; font-size: 0.95rem;
    }
    .nav-item:hover, .nav-item.active {
        background-color: rgba(255,255,255,0.08); color: #fff; border-left-color: var(--primary-accent);
    }
    .nav-item i { width: 28px; text-align: center; margin-right: 8px; font-size: 1rem; }

    .sidebar-footer {
        padding: 15px 20px; background-color: rgba(0,0,0,0.3);
        font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.1);
        flex-shrink: 0;
    }
    
    .author-link { color: #fff; text-decoration: none; transition: color 0.2s; display: block; }
    .author-link:hover { color: var(--primary-accent); }

    /* --- CONTENIDO PRINCIPAL --- */
    .main-content {
        flex-grow: 1; display: flex; flex-direction: column;
        overflow: hidden; position: relative; background-color: #fff;
        width: 100%; /* Asegura que ocupe el resto */
    }

    .top-header {
        height: var(--header-height); padding: 0 20px;
        display: flex; align-items: center; justify-content: space-between;
        border-bottom: 1px solid var(--border-color); background-color: #fff;
        flex-shrink: 0;
    }
    .header-title {
        font-size: 1.25rem; color: #34495e; font-weight: 600;
        display: flex; align-items: center; gap: 10px;
        overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }

    /* --- BARRA DE FILTROS --- */
    .filters-bar {
        padding: 15px 20px; background-color: #f8f9fa;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }
    
    .filter-tabs { display: flex; gap: 25px; overflow-x: auto; white-space: nowrap; scrollbar-width: none; }
    .filter-tabs::-webkit-scrollbar { display: none; }
    
    .filter-tab {
        padding-bottom: 8px; font-size: 0.85rem; color: #7f8c8d;
        font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
        border-bottom: 3px solid transparent; cursor: pointer;
        display: flex; align-items: center; gap: 6px;
    }
    .filter-tab:hover { color: #2c3e50; }
    .filter-tab.active { color: #2c3e50; border-bottom-color: var(--primary-accent); }

    .view-dropdown .dropdown-toggle::after { display: none; }
    .view-dropdown:hover { color: var(--primary-accent); }

    /* --- ESPACIO DE TRABAJO --- */
    .workspace {
        flex-grow: 1; overflow-y: auto; padding: 20px; background-color: var(--bg-body);
        -webkit-overflow-scrolling: touch; /* Scroll suave en iOS */
    }

    /* --- TABLA DINÁMICA --- */
    .table-container {
        background: #fff; border-radius: 6px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        border: 1px solid #e9ecef;
        overflow-x: auto; /* Scroll horizontal si la tabla es muy ancha */
    }
    
    .tree-table {
        width: 100%; border-collapse: collapse; white-space: nowrap;
    }
    .tree-table th {
        background-color: #fff; border-bottom: 2px solid #f1f1f1;
        padding: 14px 16px; text-align: left; font-weight: 700;
        font-size: 0.8rem; color: #2c3e50; text-transform: uppercase;
        position: sticky; top: 0; z-index: 10; /* Cabecera fija al hacer scroll */
    }
    .tree-table td {
        padding: 12px 16px; border-bottom: 1px solid #f5f6fa;
        font-size: 0.9rem; color: #505c6e; vertical-align: middle;
    }
    .tree-table tr:last-child td { border-bottom: none; }
    .tree-table tr:hover { background-color: #fcfcfc; }
    
    .node-icon { color: var(--folder-icon-color); margin-right: 10px; font-size: 1.1rem; }
    
    /* Tipografía Columnas */
    .col-numeric { text-align: right; font-family: 'Roboto Mono', monospace; color: #34495e; font-weight: 500; }
    .col-badge span { font-size: 0.7rem; padding: 4px 10px; border-radius: 20px; font-weight: 600; letter-spacing: 0.5px;}
    .col-main { font-weight: 600; color: #2c3e50; display: flex; align-items: center; }

    /* --- BOTÓN IA FLOTANTE --- */
    .ai-fab {
        position: fixed; bottom: 25px; right: 25px; 
        width: 60px; height: 60px; 
        z-index: 3000;
        border: none;
        background: linear-gradient(135deg, #3498db, #8e44ad);
        color: white;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .ai-fab:active { transform: scale(0.95); }

    /* --- GRAFO --- */
    #network-container { width: 100%; height: 600px; background: #fff; border: 1px solid #ddd; border-radius: 4px; }

    /* --- TOMSELECT & OVERLAYS --- */
    .ts-control { border-radius: 4px; border-color: #ced4da; padding-top: 8px; padding-bottom: 8px; }
    .ts-dropdown, .ts-control { z-index: 2000 !important; }
    .overlay-backdrop {
        display: none; position: fixed; top:0; left:0; width:100%; height:100%;
        background: rgba(0,0,0,0.5); z-index: 1040;
        backdrop-filter: blur(2px);
        transition: opacity 0.3s;
    }
    .overlay-backdrop.show { display: block; }

    /* Ocultar secciones dinámicas */
    .view-section.hidden { display: none !important; }

    /* =========================================
       RESPONSIVE MOBILE (Max-Width 991px)
       ========================================= */
    @media (max-width: 991px) {
        .app-container { flex-direction: column; }
        
        .sidebar {
            position: fixed; top: 0; left: 0; height: 100%;
            transform: translateX(-100%);
            box-shadow: 5px 0 15px rgba(0,0,0,0.1);
        }
        .sidebar.show { transform: translateX(0); }

        .top-header { padding: 0 15px; }
        .header-title { font-size: 1rem; }
        .header-title i { font-size: 1.1rem; }

        .filters-bar { padding: 10px 15px; }
        .filter-tabs { margin-bottom: 15px; }
        
        /* Ajuste de formulario en móvil */
        #searchForm { flex-direction: row; }
        
        .workspace { padding: 15px; }

        /* Grafo más pequeño en móvil para ver contenido */
        #network-container { height: 50vh; }

        /* Ajustes de tabla */
        .tree-table th, .tree-table td { padding: 10px; font-size: 0.85rem; }
        .node-icon { margin-right: 6px; }
        
        /* Ajuste botón IA */
        .ai-fab { bottom: 20px; right: 20px; width: 55px; height: 55px; }
    }
</style>

<div class="app-container">
    <!-- CAPA OSCURA PARA MÓVIL -->
    <div class="overlay-backdrop" id="mobileBackdrop" onclick="toggleSidebar()"></div>

    <!-- 1. SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <div class="d-flex justify-content-between align-items-center">
                <div><div class="brand-title">Nexus 1</div><div class="brand-subtitle text-white-50">v2024.34.6</div></div>
                <button class="btn btn-link text-white-50 d-lg-none p-0" onclick="toggleSidebar()"><i class="fa-solid fa-times fa-lg"></i></button>
            </div>
            <div class="mt-2 text-white-50 small" style="font-size: 0.7rem; font-weight: 500;">Industrial Graph Analytics</div>
        </div>

        <!-- Buscador menú -->
        <div class="p-3">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-secondary border-0 text-white"><i class="fa-solid fa-magnifying-glass"></i></span>
                <input type="text" class="form-control bg-secondary border-0 text-white shadow-none" placeholder="Buscar herramienta..." style="--bs-bg-opacity: .3; color: #fff;">
            </div>
        </div>

        <nav class="sidebar-menu">
            <a href="/" class="nav-item"><i class="fa-solid fa-house"></i> Inicio</a>
            
            {% for category, queries in categorized_queries %}
            <div class="nav-header">{{ category }}</div>
            {% for q in queries %}
            <div class="nav-item" onclick="selectQuery('{{ q.id }}', '{{ q.title }}')">
                <i class="fa-solid {{ q.icon }}"></i> 
                <span class="text-truncate">{{ q.title }}</span>
            </div>
            {% endfor %}
            {% endfor %}

            <div class="nav-header">ASISTENCIA IA</div>
            {% for category, tools in ai_tools_groups %}
                {% for t in tools %}
                <div class="nav-item" style="color: #a29bfe;" onclick="triggerAiTool('{{ t.title }}', '{{ t.id }}')">
                    <i class="fa-solid {{ t.icon }}"></i> {{ t.title }}
                </div>
                {% endfor %}
            {% endfor %}
        </nav>

        <div class="sidebar-footer">
            <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3 shadow-sm" style="width:36px; height:36px;">
                    <span class="fw-bold text-white" style="font-size: 0.9rem;">AU</span>
                </div>
                <div class="overflow-hidden">
                    <a href="https://angelurbinacv.netlify.app/" target="_blank" class="author-link">
                        <div class="fw-bold text-truncate">Angel A. Urbina</div>
                    </a>
                    <div style="font-size: 0.7rem; opacity: 0.6;">Autor / Developer</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- 2. CONTENIDO -->
    <main class="main-content">
        <!-- TOP HEADER -->
        <header class="top-header">
            <div class="header-title">
                <button class="btn btn-link text-dark d-lg-none me-3 p-0" onclick="toggleSidebar()"><i class="fa-solid fa-bars fa-lg"></i></button>
                <i class="fa-solid fa-folder-tree text-secondary d-none d-md-inline"></i>
                <span id="headerTitleText">{% if results %} {{ results.query_title }} {% else %} Panel de Control {% endif %}</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="d-none d-sm-flex align-items-center gap-2">
                    <img src="https://flagcdn.com/w20/es.png" alt="ES" class="rounded-1 shadow-sm">
                    <span class="text-muted small">ES</span>
                </div>
                <div class="vr h-50 mx-1 d-none d-sm-block"></div>
                <button class="btn btn-link text-secondary p-0"><i class="fa-regular fa-bell"></i></button>
                <button class="btn btn-link text-secondary p-0"><i class="fa-regular fa-user"></i></button>
            </div>
        </header>

        <!-- BARRA DE FILTROS & ACCIÓN -->
        <div class="filters-bar">
            <div class="row g-3 align-items-end">
                <!-- Tabs -->
                <div class="col-md-7 col-12">
                    <div class="filter-tabs">
                        <div class="filter-tab active">
                            <i class="fa-solid fa-globe me-1"></i> FILTROS 
                            <div class="d-none d-sm-block ms-1" style="font-size: 0.7rem; color: #95a5a6; font-weight: normal; margin-top:2px;">plant <strong>03(022)</strong></div>
                        </div>
                        
                        <!-- DROPWDOWN VISTA -->
                        <div class="filter-tab dropdown view-dropdown">
                            <span class="dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fa-solid fa-layer-group me-1"></i> VISTA <i class="fa-solid fa-caret-down ms-1 small opacity-50"></i>
                            </span>
                            <ul class="dropdown-menu shadow border-0 mt-2">
                                <li>
                                    <button class="dropdown-item d-flex align-items-center py-2" onclick="switchView('table')">
                                        <i class="fa-solid fa-table me-3 text-secondary"></i> Tabla de Datos
                                    </button>
                                </li>
                                <li>
                                    {% if results and results.is_graph %}
                                    <button class="dropdown-item d-flex align-items-center py-2" onclick="switchView('graph')">
                                        <i class="fa-solid fa-circle-nodes me-3 text-primary"></i> Grafo de Relaciones
                                    </button>
                                    {% else %}
                                    <button class="dropdown-item d-flex align-items-center py-2 text-muted" disabled style="opacity: 0.6;">
                                        <i class="fa-solid fa-circle-nodes me-3"></i> Grafo (No disponible)
                                    </button>
                                    {% endif %}
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Buscador -->
                <div class="col-md-5 col-12">
                     <form id="searchForm" action="/query" method="POST">
                        <input type="hidden" name="query_id" id="hiddenQueryId" value="{{ current_query | default(value='M01') }}">
                        
                        <div class="d-flex justify-content-between align-items-baseline mb-1">
                            <span class="text-uppercase fw-bold text-primary" style="font-size: 0.7rem;" id="queryNameLabel">
                                {% if results %}{{ results.query_title }}{% else %}Selecciona herramienta{% endif %}
                            </span>
                        </div>

                        <div class="d-flex gap-2">
                            <div style="flex-grow: 1;">
                                <select id="select-param" name="param" placeholder="Parámetro (ID/Nombre)..." style="width: 100%;"></select>
                            </div>
                            <button type="submit" class="btn btn-primary fw-bold px-3 d-flex align-items-center shadow-sm">
                                <i class="fa-solid fa-bolt me-md-2"></i> <span class="d-none d-md-inline">EJECUTAR</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ESPACIO DE TRABAJO -->
        <div class="workspace">
            
            <!-- Toolbar Contextual -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-white text-dark border p-2 shadow-sm d-flex align-items-center gap-2">
                        <i class="fa-solid fa-server text-success small"></i> 
                        <span class="d-none d-sm-inline">Estado:</span> <strong>Online</strong>
                    </span>
                    <span class="badge bg-info bg-opacity-10 text-info border border-info p-2 d-none d-sm-inline" id="viewModeBadge">
                        {% if results and results.is_graph %}Vista: Grafo{% else %}Vista: Tabla{% endif %}
                    </span>
                </div>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-sm btn-white border bg-white" title="Exportar CSV" onclick="exportCSV()"><i class="fa-solid fa-file-csv text-success"></i><span class="d-none d-md-inline ms-1">CSV</span></button>
                    <button class="btn btn-sm btn-white border bg-white" title="Descargar PNG" onclick="downloadGraphPNG()"><i class="fa-solid fa-image text-primary"></i><span class="d-none d-md-inline ms-1">PNG</span></button>
                    <button class="btn btn-sm btn-white border bg-white" title="Gráficos" data-bs-toggle="modal" data-bs-target="#statsModal"><i class="fa-solid fa-chart-pie text-danger"></i></button>
                </div>
            </div>

            {% if results %}
                <!-- VISTA GRAFO (Por defecto si es grafo) -->
                <div id="view-graph" class="view-section {% if not results.is_graph %}hidden{% endif %}">
                    {% if results.is_graph %}
                        <div class="bg-white p-1 rounded shadow-sm border">
                            <div id="network-container"></div>
                            <div class="d-flex justify-content-between px-3 py-2 bg-light border-top small text-muted">
                                <span><i class="fa-solid fa-mouse me-1"></i> Scroll: Zoom | Arrastrar: Mover</span>
                                <span>{{ results.rows | length }} Nodos</span>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-light border shadow-sm text-center py-4">
                            <i class="fa-solid fa-diagram-project text-muted fa-2x mb-2 opacity-50"></i><br>
                            Esta consulta es tabular, no genera grafo.
                        </div>
                    {% endif %}
                </div>

                <!-- VISTA TABLA (Oculta si es grafo inicialmente) -->
                <div id="view-table" class="view-section {% if results.is_graph %}hidden{% endif %}">
                    <div class="table-container">
                        <table class="tree-table">
                            <thead>
                                <tr>
                                    {% for col in results.columns %}
                                        <th class="{% if 'PRECIO' in col or 'COSTO' in col or 'STOCK' in col or 'CANT' in col or 'TOTAL' in col %}text-end{% endif %}">
                                            {{ col | replace(from="_", to=" ") }}
                                        </th>
                                    {% endfor %}
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in results.rows %}
                                
                                {# Extracción segura de datos para las acciones #}
                                {% set row_id = row.ID | default(value=row.A_ID | default(value=row.CODIGO | default(value=row.MATERIAL | default(value="")))) %}
                                {% set row_label = row.NAME | default(value=row.A_LABEL | default(value=row.DESCRIPCION | default(value=row.EQUIPO | default(value="")))) %}

                                <tr>
                                    {% for col in results.columns %}
                                        {% set val = row[col] %}
                                        
                                        <!-- Renderizado condicional de celdas -->
                                        {% if loop.first %}
                                            <td class="col-main">
                                                {% if row.B_TYPE and ("Equipo" in row.B_TYPE or "Ubicacion" in row.B_TYPE) %}
                                                    <i class="fa-regular fa-folder node-icon"></i>
                                                {% else %}
                                                    <i class="fa-solid fa-cube text-secondary me-2 small opacity-50"></i>
                                                {% endif %}
                                                <span class="text-truncate" style="max-width: 250px; display:inline-block;">{{ val }}</span>
                                            </td>

                                        {% elif 'TYPE' in col or 'TIPO' in col or 'STATUS' in col or 'ESTADO' in col %}
                                            <td class="col-badge">
                                                <span class="badge bg-light text-secondary border">{{ val }}</span>
                                            </td>

                                        {% elif 'PRECIO' in col or 'COSTO' in col or 'STOCK' in col or 'CANT' in col or 'TOTAL' in col %}
                                            <td class="col-numeric">{{ val }}</td>

                                        {% else %}
                                            <td>{{ val }}</td>
                                        {% endif %}
                                    {% endfor %}

                                    <td class="text-center">
                                        <div class="dropdown">
                                            <button class="btn btn-link btn-sm text-secondary p-0" data-bs-toggle="dropdown"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                                <li><a class="dropdown-item small" href="#"><i class="fa-solid fa-eye me-2"></i> Ver detalle</a></li>
                                                {% if row_id %}
                                                <li><a class="dropdown-item small" href="#" onclick="updateSearchParam('{{ row_id }}', '{{ row_label }}')"><i class="fa-solid fa-filter me-2"></i> Filtrar por: <b>{{ row_label }}</b></a></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                
                                <!-- Footer Tabla -->
                                <tr style="background-color: #f8f9fa; font-weight: 600; border-top: 2px solid #e9ecef;">
                                    <td class="ps-3 text-muted" colspan="100%">
                                        <i class="fa-solid fa-list-ol me-2"></i> Total Resultados: {{ results.rows | length }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            {% else %}
                <!-- EMPTY STATE -->
                <div class="d-flex flex-column align-items-center justify-content-center h-75 text-muted opacity-75">
                    <div class="bg-white p-5 rounded-circle shadow-sm mb-4 border">
                        <i class="fa-solid fa-magnifying-glass-chart fa-4x text-light-gray" style="color: #bdc3c7;"></i>
                    </div>
                    <h4 class="fw-light text-dark">Bienvenido a Nexus 1</h4>
                    <p class="small text-center mt-2">
                        1. Selecciona una herramienta en el menú.<br>
                        2. Introduce parámetros si es necesario.<br>
                        3. Pulsa <b>EJECUTAR</b> o pregunta a la <b>IA</b>.
                    </p>
                </div>
            {% endif %}
        </div>
    </main>
</div>

<!-- BOTÓN IA FLOTANTE -->
<button class="btn rounded-circle d-flex align-items-center justify-content-center ai-fab" 
        data-bs-toggle="modal" data-bs-target="#aiModal" title="Asistente IA">
    <i class="fa-solid fa-robot fa-xl"></i>
</button>

<!-- MODALS -->
<div class="modal fade" id="statsModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Estadísticas</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><canvas id="mainChart" style="max-height: 400px;"></canvas></div></div></div></div>

<div class="modal fade" id="aiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content border-0 shadow-lg" style="height: 80vh;">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fs-6"><i class="fa-solid fa-brain me-2 text-info"></i> Asistente Nexus</h5>
                <div class="ms-auto"><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            </div>
            <div class="modal-body bg-light p-3" id="chatArea" style="overflow-y: auto;">
                <div class="d-flex mb-3"><div class="bg-white border rounded p-3 shadow-sm">Hola, soy tu copiloto de ingeniería industrial. ¿En qué puedo ayudarte hoy?</div></div>
            </div>
            <div class="modal-footer p-2 bg-white"><div class="input-group"><input type="text" id="userPrompt" class="form-control border-0 bg-light" placeholder="Pregunta algo (ej: repuestos críticos)..." onkeypress="handleEnter(event)"><button class="btn btn-primary" onclick="sendPrompt()"><i class="fa-solid fa-paper-plane"></i></button></div></div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end shadow" tabindex="-1" id="nodeOffcanvas" data-bs-backdrop="false">
    <div class="offcanvas-header bg-primary text-white"><h5 class="fw-bold">Detalle</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body"><h5 id="canvasNodeLabel" class="fw-bold"></h5><code id="canvasNodeId" class="d-block mb-3 text-muted"></code><button class="btn btn-primary w-100 mb-2" onclick="setFocusFromCanvas()">Usar como filtro</button></div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // --- LÓGICA DE INTERFAZ ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('mobileBackdrop').classList.toggle('show'); }
    
    function selectQuery(id, title) {
        document.getElementById('hiddenQueryId').value = id;
        document.getElementById('headerTitleText').innerText = title;
        document.getElementById('queryNameLabel').innerText = title;
        if(tomSelectInstance) { tomSelectInstance.clear(); tomSelectInstance.focus(); }
        if(window.innerWidth < 992) toggleSidebar();
    }

    // --- SWITCH VISTAS (TABLA / GRAFO) ---
    function switchView(viewName) {
        const graphDiv = document.getElementById('view-graph');
        const tableDiv = document.getElementById('view-table');
        const badge = document.getElementById('viewModeBadge');

        if (viewName === 'graph') {
            if(graphDiv) {
                graphDiv.classList.remove('hidden');
                tableDiv.classList.add('hidden');
                badge.innerText = "Vista: Grafo";
                if(network) network.fit(); 
            }
        } else {
            if(graphDiv) graphDiv.classList.add('hidden');
            tableDiv.classList.remove('hidden');
            badge.innerText = "Vista: Tabla";
        }
    }

    let tomSelectInstance;
    document.addEventListener("DOMContentLoaded", function(){
        tomSelectInstance = new TomSelect("#select-param", {
            valueField: 'id', labelField: 'title', searchField: ['title', 'id'],
            preload: 'focus', placeholder: 'Escribe ID o Nombre...',
            create: false, maxItems: 1, plugins: ['dropdown_input'],
            onItemAdd: function() { this.setTextboxValue(''); },
            load: function(query, callback) {
                fetch('/api/search?q=' + encodeURIComponent(query || ''))
                    .then(r => r.json()).then(json => callback(json)).catch(() => callback());
            },
            render: {
                option: (item, escape) => `<div class="py-2 px-3 border-bottom"><div class="fw-bold text-dark">${escape(item.title)}</div><div class="small text-muted">${escape(item.label || 'Nodo')}</div></div>`,
                item: (item, escape) => `<div>${escape(item.title)}</div>`
            }
        });
        {% if current_param %}
            setTimeout(() => { tomSelectInstance.addOption({id: "{{current_param}}", title: "{{current_param_label}}"}); tomSelectInstance.setValue("{{current_param}}"); }, 100);
        {% endif %}
        
        const savedConfig = localStorage.getItem("ai_config");
        if(savedConfig) { try { aiConfig = JSON.parse(savedConfig); } catch(e){} }
        loadTools();
    });

    function updateSearchParam(id, label) {
        if(!tomSelectInstance) return;
        tomSelectInstance.clear(true); tomSelectInstance.clearOptions();
        tomSelectInstance.addOption({id:id, title:label}); tomSelectInstance.setValue(id);
    }

    {% if results %}
        const rows = {{ results.rows | json_encode() | safe }};
        const cols = {{ results.columns | json_encode() | safe }};
        const isGraphQuery = {{ results.is_graph | json_encode() }};
        let network = null, selectedNodeData = null;

        if (isGraphQuery && document.getElementById('network-container')) {
            const nodes = new Map(), edges = [];
            rows.forEach(r => {
                const keys = Object.keys(r);
                const aIdKey = keys.find(k => k.includes('A_ID') || k === 'ID' || k === 'CODIGO');
                const bIdKey = keys.find(k => k.includes('B_ID'));
                const aLabelKey = keys.find(k => k.includes('A_LABEL') || k === 'NAME' || k === 'DESCRIPCION' || k === 'EQUIPO');
                const bLabelKey = keys.find(k => k.includes('B_LABEL'));
                
                const aId = r[aIdKey] || r.ID; 
                const aLabel = r[aLabelKey] || aId;
                
                if(aId && !nodes.has(aId)) nodes.set(aId, {id:aId, label:aLabel, group:r.A_TYPE||'Default'});
                
                if(bIdKey && r[bIdKey]) {
                    const bId = r[bIdKey]; 
                    const bLabel = r[bLabelKey] || bId;
                    if(!nodes.has(bId)) nodes.set(bId, {id:bId, label:bLabel, group:r.B_TYPE||'Default'});
                    edges.push({from:aId, to:bId, label:r.RELACION||'', arrows:'to'});
                }
            });
            network = new vis.Network(document.getElementById('network-container'), {
                nodes: new vis.DataSet(Array.from(nodes.values())), edges: new vis.DataSet(edges)
            }, { 
                nodes: { shape: 'dot', font: { face: 'Segoe UI' } }, 
                physics: { stabilization: false },
                layout: { improvedLayout: true }
            });
            network.on("click", p => {
                if(p.nodes.length) {
                    const n = nodes.get(p.nodes[0]);
                    selectedNodeData = n;
                    document.getElementById('canvasNodeLabel').innerText = n.label;
                    document.getElementById('canvasNodeId').innerText = n.id;
                    new bootstrap.Offcanvas(document.getElementById('nodeOffcanvas')).show();
                }
            });
        }

        const numCol = cols.find(c => ['CANTIDAD','TOTAL','SCORE','PRECIO','STOCK'].some(k => c.includes(k)));
        const lblCol = cols.find(c => ['DESCRIPCION','NAME','EQUIPO'].some(k => c.includes(k))) || cols[0];
        if (numCol && rows.length && document.getElementById('mainChart')) {
            new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'bar',
                data: { labels: rows.map(r=>String(r[lblCol]).substring(0,15)), datasets: [{ label: numCol, data: rows.map(r=>parseFloat(r[numCol])||0), backgroundColor: '#3498db' }] },
                options: { maintainAspectRatio: false }
            });
        }
    {% endif %}

    function exportCSV() {
        if (typeof rows === 'undefined' || !rows.length) return alert("Sin datos");
        const headers = cols.join(",");
        const csvRows = rows.map(row => cols.map(c => `"${String(row[c]||'').replace(/"/g,'""')}"`).join(","));
        const blob = new Blob(["\uFEFF" + [headers, ...csvRows].join("\r\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
        link.download = `nexus_export_${new Date().toISOString().slice(0,10)}.csv`; link.click();
    }

    function downloadGraphPNG() {
        if (!network) return alert("No hay grafo visible");
        const canvas = document.getElementById('network-container').getElementsByTagName('canvas')[0];
        const temp = document.createElement('canvas'); temp.width = canvas.width; temp.height = canvas.height;
        const ctx = temp.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0,0,temp.width,temp.height);
        ctx.drawImage(canvas, 0, 0);
        const link = document.createElement('a'); link.href = temp.toDataURL("image/png");
        link.download = "grafo.png"; link.click();
    }

    function setFocusFromCanvas() { if (selectedNodeData) updateSearchParam(selectedNodeData.id, selectedNodeData.label); }

    // IA Logic
    const PROVIDERS = { openai: { url: "https://api.openai.com/v1/chat/completions", model: "gpt-4o" }, groq: { url: "https://api.groq.com/openai/v1/chat/completions", model: "llama3-70b-8192" }, ollama: { url: "http://localhost:11434/v1/chat/completions", model: "llama3" } };
    let aiConfig = { provider: 'openai', baseUrl: PROVIDERS.openai.url, model: PROVIDERS.openai.model, key: '' };
    let chatHistory = [{role: "system", content: "Eres un experto industrial."}];
    let availableTools = null;
    function saveAiConfig() { aiConfig = { provider: document.getElementById('aiProviderSelect').value, baseUrl: document.getElementById('aiBaseUrl').value, model: document.getElementById('aiModelName').value, key: document.getElementById('aiApiKey').value }; localStorage.setItem("ai_config", JSON.stringify(aiConfig)); }
    function loadTools() { fetch('/api/ai/tools').then(r=>r.json()).then(d=>availableTools=d); }
    function handleEnter(e) { if(e.key==='Enter') sendPrompt(); }
    async function sendPrompt() {
        const inp = document.getElementById('userPrompt'); if(!inp.value.trim()) return;
        appendMessage('user', inp.value); chatHistory.push({role:'user', content:inp.value}); inp.value=''; const tid = showTyping();
        try {
            const res = await fetch("/api/openai_proxy", { method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${aiConfig.key}`,"x-base-url":aiConfig.baseUrl}, body:JSON.stringify({model:aiConfig.model, messages:chatHistory, tools:availableTools})});
            const data = await res.json();
            if(data.choices && data.choices[0].message.tool_calls) {
                const tc = data.choices[0].message.tool_calls[0];
                let args = JSON.parse(tc.function.arguments);
                const tRes = await fetch('/api/execute', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query_id:tc.function.name, param:args.param})});
                const tData = await tRes.json();
                chatHistory.push(data.choices[0].message);
                chatHistory.push({role:'tool', tool_call_id:tc.id, name:tc.function.name, content:JSON.stringify(tData).slice(0, 500)});
                const res2 = await fetch("/api/openai_proxy", { method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${aiConfig.key}`,"x-base-url":aiConfig.baseUrl}, body:JSON.stringify({model:aiConfig.model, messages:chatHistory})});
                const data2 = await res2.json(); removeTyping(tid); appendMessage('assistant', data2.choices[0].message.content); chatHistory.push(data2.choices[0].message);
            } else { removeTyping(tid); appendMessage('assistant', data.choices[0].message.content); }
        } catch(e) { removeTyping(tid); appendMessage('system', "Error: "+e.message); }
    }
    function appendMessage(role, text, temp) {
        const div = document.createElement('div'); div.className = `d-flex align-items-start mb-3 ${role==='user'?'justify-content-end':''}`;
        div.innerHTML = `<div class="${role==='user'?'bg-primary text-white':'bg-white border'} rounded p-3 shadow-sm" style="max-width:85%;">${text}</div>`;
        document.getElementById('chatArea').append(div);
    }
    function showTyping() { const id='t-'+Date.now(); appendMessage('system', '<div id="'+id+'">...</div>'); return id; }
    function removeTyping(id) { if(id) document.getElementById(id)?.parentElement?.parentElement?.remove(); }
</script>
{% endblock %}