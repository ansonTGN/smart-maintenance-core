{% extends "base.html" %}

{% block content %}
<style>
    /* --- TEMA VISUAL: TAM 4 STYLE --- */
    :root {
        --sidebar-bg: #2c3e50;
        --sidebar-width: 280px;
        --header-height: 60px;
        --primary-accent: #3498db;
        --bg-body: #f4f6f9;
        --text-dark: #333;
        --text-light: #ecf0f1;
        --border-color: #dee2e6;
        --folder-icon-color: #f1c40f;
    }

    body {
        background-color: var(--bg-body);
        font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
        overflow: hidden;
    }

    /* --- LAYOUT --- */
    .app-container { display: flex; height: 100vh; width: 100vw; }

    /* --- SIDEBAR --- */
    .sidebar {
        width: var(--sidebar-width);
        background-color: var(--sidebar-bg);
        color: var(--text-light);
        display: flex; flex-direction: column;
        transition: transform 0.3s ease;
        z-index: 1050; flex-shrink: 0;
    }

    .sidebar-brand {
        padding: 15px 20px;
        background-color: rgba(0,0,0,0.2);
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .brand-title { font-weight: 700; font-size: 1.1rem; line-height: 1.2; }
    .brand-subtitle { font-size: 0.75rem; opacity: 0.7; font-family: monospace; }

    .sidebar-menu { flex-grow: 1; overflow-y: auto; padding-top: 10px; }

    .nav-header {
        font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
        color: rgba(255,255,255,0.5); padding: 15px 20px 5px 20px; font-weight: 600;
    }

    .nav-item {
        padding: 10px 20px; color: #bdc3c7; text-decoration: none;
        display: flex; align-items: center; border-left: 3px solid transparent;
        cursor: pointer; transition: all 0.2s; font-size: 0.9rem;
    }
    .nav-item:hover, .nav-item.active {
        background-color: rgba(255,255,255,0.05); color: #fff; border-left-color: var(--primary-accent);
    }
    .nav-item i { width: 25px; text-align: center; margin-right: 10px; }

    .sidebar-footer {
        padding: 15px 20px; background-color: rgba(0,0,0,0.3);
        font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* --- CONTENIDO --- */
    .main-content {
        flex-grow: 1; display: flex; flex-direction: column;
        overflow: hidden; position: relative; background-color: #fff;
    }

    .top-header {
        height: var(--header-height); padding: 0 20px;
        display: flex; align-items: center; justify-content: space-between;
        border-bottom: 1px solid var(--border-color); background-color: #fff;
    }
    .header-title {
        font-size: 1.25rem; color: #5f6e82; font-weight: 600;
        display: flex; align-items: center; gap: 10px;
    }

    .filters-bar {
        padding: 15px 20px 0 20px; background-color: #fcfcfc;
        border-bottom: 1px solid var(--border-color);
    }
    .filter-tabs { display: flex; gap: 30px; }
    .filter-tab {
        padding-bottom: 10px; font-size: 0.9rem; color: #7f8c8d;
        font-weight: 600; text-transform: uppercase;
        border-bottom: 3px solid transparent; cursor: pointer;
    }
    .filter-tab.active { color: #2c3e50; border-bottom-color: #2c3e50; }

    .workspace {
        flex-grow: 1; overflow-y: auto; padding: 20px; background-color: var(--bg-body);
    }

    /* --- TABLA TAM 4 (DIN츼MICA) --- */
    .tree-table {
        background: #fff; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        width: 100%; border-collapse: collapse; white-space: nowrap;
    }
    .tree-table th {
        background-color: #fff; border-bottom: 1px solid #eee;
        padding: 12px 15px; text-align: left; font-weight: 700;
        font-size: 0.85rem; color: #333; text-transform: uppercase;
    }
    .tree-table td {
        padding: 10px 15px; border-bottom: 1px solid #f0f0f0;
        font-size: 0.9rem; color: #555; vertical-align: middle;
    }
    .tree-table tr:hover { background-color: #f8f9fa; }
    
    .node-icon { color: var(--folder-icon-color); margin-right: 8px; }
    
    /* Clases utilitarias para columnas din치micas */
    .col-numeric { text-align: right; font-family: 'Roboto Mono', monospace; color: #2c3e50; }
    .col-badge span { font-size: 0.75rem; padding: 3px 8px; border-radius: 12px; }
    .col-main { font-weight: 600; color: #2c3e50; }

    /* --- EXTRAS --- */
    #network-container { width: 100%; height: 600px; background: #fff; border: 1px solid #ddd; }
    .ts-dropdown, .ts-control { z-index: 2000 !important; }

    @media (max-width: 991px) {
        .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
        .sidebar.show { transform: translateX(0); }
        .overlay-backdrop {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 1040;
        }
        .overlay-backdrop.show { display: block; }
        .tree-table { display: block; overflow-x: auto; }
    }
</style>

<div class="app-container">
    <div class="overlay-backdrop" id="mobileBackdrop" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <div class="d-flex justify-content-between align-items-center">
                <div><div class="brand-title">TAM 4</div><div class="brand-subtitle text-white-50">v2024.34.6</div></div>
                <button class="btn btn-sm text-white d-lg-none" onclick="toggleSidebar()"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="mt-2 text-white-50 small" style="font-size: 0.7rem;">Nexus Industrial Graph Analytics</div>
        </div>

        <div class="p-3">
            <div class="input-group input-group-sm">
                <span class="input-group-text bg-secondary border-0 text-white"><i class="fa-solid fa-magnifying-glass"></i></span>
                <input type="text" class="form-control bg-secondary border-0 text-white" placeholder="Buscar..." style="--bs-bg-opacity: .4; color:white::placeholder;">
            </div>
        </div>

        <nav class="sidebar-menu">
            <a href="/" class="nav-item"><i class="fa-solid fa-house"></i> Inicio</a>
            {% for category, queries in categorized_queries %}
            <div class="nav-header">{{ category }}</div>
            {% for q in queries %}
            <div class="nav-item" onclick="selectQuery('{{ q.id }}', '{{ q.title }}')">
                <i class="fa-solid {{ q.icon }}"></i> <span class="text-truncate">{{ q.title }}</span>
            </div>
            {% endfor %}
            {% endfor %}
            <div class="nav-header">HERRAMIENTAS IA</div>
            {% for category, tools in ai_tools_groups %}
                {% for t in tools %}
                <div class="nav-item" style="color: #a29bfe;" onclick="triggerAiTool('{{ t.title }}', '{{ t.id }}')">
                    <i class="fa-solid {{ t.icon }}"></i> {{ t.title }}
                </div>
                {% endfor %}
            {% endfor %}
        </nav>

        <div class="sidebar-footer">
            <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width:30px; height:30px;">
                    <i class="fa-solid fa-user text-white" style="font-size: 0.8rem;"></i>
                </div>
                <div><div class="fw-bold">Angel A. Urbina</div><div style="font-size: 0.7rem; opacity: 0.6;">Autor / Developer</div></div>
            </div>
        </div>
    </aside>

    <!-- CONTENIDO -->
    <main class="main-content">
        <header class="top-header">
            <div class="header-title">
                <button class="btn btn-link text-dark d-lg-none me-2 p-0" onclick="toggleSidebar()"><i class="fa-solid fa-bars fa-lg"></i></button>
                <i class="fa-solid fa-folder-tree text-secondary"></i>
                <span id="headerTitleText">{% if results %} {{ results.query_title }} {% else %} Navegaci칩n del 츼rbol {% endif %}</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <img src="https://flagcdn.com/w20/es.png" alt="ES" class="rounded-1" style="opacity: 0.8;">
                <div class="vr h-50 mx-1"></div>
                <i class="fa-regular fa-bell text-secondary cursor-pointer"></i>
                <i class="fa-regular fa-user text-secondary cursor-pointer"></i>
            </div>
        </header>

        <div class="filters-bar">
            <div class="row align-items-end">
                <div class="col-md-8">
                    <div class="filter-tabs">
                        <div class="filter-tab active"><i class="fa-solid fa-globe me-1"></i> FILTROS GEOGR츼FICOS <div style="font-size: 0.7rem; color: #95a5a6; font-weight: normal; margin-top:2px;">plant es <strong>03(022)</strong></div></div>
                        <div class="filter-tab"><i class="fa-solid fa-layer-group me-1"></i> CATEGOR칈A</div>
                    </div>
                </div>
                <div class="col-md-4 pb-2">
                     <form id="searchForm" action="/query" method="POST" class="d-flex gap-2">
                        <input type="hidden" name="query_id" id="hiddenQueryId" value="{{ current_query | default(value='M01') }}">
                        <div style="flex-grow: 1;"><select id="select-param" name="param" placeholder="Buscar nodo..." style="width: 100%;"></select></div>
                        <button type="submit" class="btn btn-primary btn-sm"><i class="fa-solid fa-arrow-right"></i></button>
                    </form>
                </div>
            </div>
        </div>

        <div class="workspace">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex gap-2">
                    <span class="badge bg-white text-dark border p-2">categor칤as: <strong>Din치mica</strong></span>
                    <button class="btn btn-link btn-sm text-secondary text-decoration-none">Establecer como filtro</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-secondary bg-white" title="Exportar CSV" onclick="exportCSV()"><i class="fa-solid fa-file-csv"></i></button>
                    <button class="btn btn-sm btn-outline-secondary bg-white" title="Descargar PNG" onclick="downloadGraphPNG()"><i class="fa-solid fa-camera"></i></button>
                    <button class="btn btn-sm btn-outline-secondary bg-white" title="Gr치ficos" data-bs-toggle="modal" data-bs-target="#statsModal"><i class="fa-solid fa-chart-pie"></i></button>
                </div>
            </div>

            {% if results %}
                {% if results.is_graph %}
                    <!-- VISTA GRAFO -->
                    <div class="bg-white p-2 rounded shadow-sm border">
                        <div id="network-container"></div>
                        <div class="text-center small text-muted mt-2"><i class="fa-solid fa-circle-info"></i> Usa el scroll para zoom y arrastra los nodos.</div>
                    </div>
                {% else %}
                    <!-- VISTA TABLA DIN츼MICA MEJORADA -->
                    <div class="table-responsive bg-white rounded shadow-sm border" style="min-height: 400px;">
                        <table class="tree-table">
                            <thead>
                                <tr>
                                    <!-- Cabecera Din치mica corregida -->
                                    {% for col in results.columns %}
                                        <th class="{% if 'PRECIO' in col or 'COSTO' in col or 'STOCK' in col or 'CANT' in col or 'TOTAL' in col %}text-end{% endif %}">
                                            {{ col | replace(from="_", to=" ") }}
                                            {% if 'PRECIO' in col or 'COSTO' in col %}<i class="fa-solid fa-euro-sign ms-1 text-muted" style="font-size:0.7em;"></i>{% endif %}
                                        </th>
                                    {% endfor %}
                                    <th style="width: 50px;"></th> <!-- Columna Acciones -->
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in results.rows %}
                                
                                {# Identificaci칩n inteligente de ID y Etiqueta para las acciones #}
                                {% set row_id = row.ID | default(value=row.A_ID | default(value=row.CODIGO | default(value=row.MATERIAL | default(value="")))) %}
                                {% set row_label = row.NAME | default(value=row.A_LABEL | default(value=row.DESCRIPCION | default(value=row.EQUIPO | default(value="")))) %}

                                <tr>
                                    {% for col in results.columns %}
                                        {% set val = row[col] %}
                                        
                                        <!-- L칩gica de renderizado por tipo de columna (CORREGIDA CON 'in') -->
                                        {% if loop.first %}
                                            <!-- PRIMERA COLUMNA: Estilo 츼rbol Principal -->
                                            <td class="col-main">
                                                {% if row.B_TYPE and ("Equipo" in row.B_TYPE or "Ubicacion" in row.B_TYPE) %}
                                                    <i class="fa-regular fa-folder node-icon"></i>
                                                {% else %}
                                                    <i class="fa-solid fa-cube text-secondary me-2 small"></i>
                                                {% endif %}
                                                {{ val }}
                                            </td>

                                        {% elif 'TYPE' in col or 'TIPO' in col or 'STATUS' in col or 'ESTADO' in col %}
                                            <!-- COLUMNAS TIPO/ESTADO: Badge -->
                                            <td class="col-badge">
                                                <span class="badge bg-light text-secondary border">{{ val }}</span>
                                            </td>

                                        {% elif 'PRECIO' in col or 'COSTO' in col or 'STOCK' in col or 'CANT' in col or 'TOTAL' in col %}
                                            <!-- COLUMNAS NUM칄RICAS: Alineaci칩n derecha -->
                                            <td class="col-numeric">
                                                {{ val }}
                                            </td>

                                        {% else %}
                                            <!-- RESTO: Normal -->
                                            <td>{{ val }}</td>
                                        {% endif %}
                                    {% endfor %}

                                    <!-- Columna de Acciones -->
                                    <td class="text-center">
                                        <div class="dropdown">
                                            <button class="btn btn-link btn-sm text-secondary p-0" data-bs-toggle="dropdown"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                                <li><a class="dropdown-item small" href="#"><i class="fa-solid fa-eye me-2"></i> Ver detalle</a></li>
                                                {% if row_id %}
                                                <li><a class="dropdown-item small" href="#" onclick="updateSearchParam('{{ row_id }}', '{{ row_label }}')"><i class="fa-solid fa-filter me-2"></i> Filtrar por: <b>{{ row_label }}</b></a></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                
                                <!-- Fila de Totales (Visual) -->
                                <tr style="background-color: #fcfcfc; font-weight: bold; border-top: 2px solid #e9ecef;">
                                    <td class="ps-3 text-muted">Resultados: {{ results.rows | length }}</td>
                                    <td colspan="{{ results.columns | length }}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            {% else %}
                <div class="d-flex flex-column align-items-center justify-content-center h-75 text-muted">
                    <div class="bg-white p-5 rounded-circle shadow-sm mb-4"><i class="fa-solid fa-folder-tree fa-4x" style="color: #e0e0e0;"></i></div>
                    <h4 class="fw-light">Selecciona una categor칤a del 치rbol</h4>
                    <p class="small">Utiliza el men칰 lateral izquierdo o pregunta a la IA.</p>
                </div>
            {% endif %}
        </div>
    </main>
</div>

<!-- COMPONENTES ADICIONALES (IA, MODALS) -->
<button class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" 
        style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; z-index: 2000; border: 4px solid #fff;"
        data-bs-toggle="modal" data-bs-target="#aiModal" title="Asistente IA"><i class="fa-solid fa-robot fa-xl"></i></button>

<div class="modal fade" id="statsModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Estad칤sticas R치pidas</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><canvas id="mainChart" style="max-height: 400px;"></canvas></div></div></div></div>

<div class="modal fade" id="aiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content border-0 shadow-lg" style="height: 80vh;">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fs-6"><i class="fa-solid fa-brain me-2 text-info"></i> Asistente Nexus</h5>
                <div class="ms-auto d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#configPanel"><i class="fa-solid fa-gear"></i></button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="collapse bg-light border-bottom p-3" id="configPanel">
                <div class="row g-2">
                    <div class="col-12"><select id="aiProviderSelect" class="form-select form-select-sm" onchange="updateProviderSettings()"><option value="openai">OpenAI</option><option value="groq">Groq</option><option value="ollama">Ollama</option></select></div>
                    <div class="col-6"><input type="text" id="aiBaseUrl" class="form-control form-control-sm" placeholder="URL"></div>
                    <div class="col-6"><input type="text" id="aiModelName" class="form-control form-control-sm" placeholder="Model"></div>
                    <div class="col-12"><input type="password" id="aiApiKey" class="form-control form-control-sm" placeholder="API Key"><button class="btn btn-primary btn-sm mt-1 w-100" onclick="saveAiConfig()">Guardar</button></div>
                </div>
            </div>
            <div class="modal-body bg-light p-0 d-flex flex-column"><div id="chatArea" class="flex-grow-1 overflow-auto p-3"><div class="d-flex mb-3"><div class="bg-white border rounded p-3 shadow-sm" style="max-width:85%;">Hola, soy tu copiloto de ingenier칤a.</div></div></div></div>
            <div class="modal-footer p-2 bg-white"><div class="input-group"><input type="text" id="userPrompt" class="form-control border-0 bg-light" placeholder="Pregunta algo..." onkeypress="handleEnter(event)"><button class="btn btn-primary" onclick="sendPrompt()"><i class="fa-solid fa-paper-plane"></i></button></div></div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end shadow" tabindex="-1" id="nodeOffcanvas" data-bs-backdrop="false">
    <div class="offcanvas-header bg-primary text-white"><h5 class="fw-bold">Detalle</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body"><h5 id="canvasNodeLabel" class="fw-bold"></h5><code id="canvasNodeId" class="d-block mb-3 text-muted"></code><button class="btn btn-primary w-100 mb-2" onclick="setFocusFromCanvas()">Usar como filtro</button></div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('mobileBackdrop').classList.toggle('show'); }
    function selectQuery(id, title) {
        document.getElementById('hiddenQueryId').value = id;
        document.getElementById('headerTitleText').innerText = title;
        document.getElementById('searchForm').submit();
        if(window.innerWidth < 992) toggleSidebar();
    }

    let tomSelectInstance;
    document.addEventListener("DOMContentLoaded", function(){
        tomSelectInstance = new TomSelect("#select-param", {
            valueField: 'id', labelField: 'title', searchField: ['title', 'id'],
            preload: 'focus', placeholder: 'Buscar nodo o material...',
            create: false, maxItems: 1, plugins: ['dropdown_input'],
            onItemAdd: function() { this.setTextboxValue(''); },
            load: function(query, callback) {
                fetch('/api/search?q=' + encodeURIComponent(query || ''))
                    .then(r => r.json()).then(json => callback(json)).catch(() => callback());
            },
            render: {
                option: (item, escape) => `<div class="py-2 px-3 border-bottom"><div class="fw-bold text-dark">${escape(item.title)}</div><div class="small text-muted">${escape(item.label || 'Nodo')}</div></div>`,
                item: (item, escape) => `<div>${escape(item.title)}</div>`
            }
        });
        {% if current_param %}
            setTimeout(() => { tomSelectInstance.addOption({id: "{{current_param}}", title: "{{current_param_label}}"}); tomSelectInstance.setValue("{{current_param}}"); }, 100);
        {% endif %}
        const savedConfig = localStorage.getItem("ai_config");
        if(savedConfig) { try { aiConfig = JSON.parse(savedConfig); } catch(e){} }
        loadTools();
    });

    function updateSearchParam(id, label) {
        if(!tomSelectInstance) return;
        tomSelectInstance.clear(true); tomSelectInstance.clearOptions();
        tomSelectInstance.addOption({id:id, title:label}); tomSelectInstance.setValue(id);
    }

    {% if results %}
        const rows = {{ results.rows | json_encode() | safe }};
        const cols = {{ results.columns | json_encode() | safe }};
        const isGraphQuery = {{ results.is_graph | json_encode() }};
        let network = null, selectedNodeData = null;

        if (isGraphQuery && document.getElementById('network-container')) {
            const nodes = new Map(), edges = [];
            rows.forEach(r => {
                const keys = Object.keys(r);
                const aIdKey = keys.find(k => k.includes('A_ID') || k === 'ID' || k === 'CODIGO');
                const bIdKey = keys.find(k => k.includes('B_ID'));
                const aLabelKey = keys.find(k => k.includes('A_LABEL') || k === 'NAME' || k === 'DESCRIPCION' || k === 'EQUIPO');
                const bLabelKey = keys.find(k => k.includes('B_LABEL'));
                
                const aId = r[aIdKey]; const aLabel = r[aLabelKey] || aId;
                const bId = r[bIdKey]; const bLabel = r[bLabelKey] || bId;
                
                if(aId && !nodes.has(aId)) nodes.set(aId, {id:aId, label:aLabel, group:r.A_TYPE||'Default'});
                if(bId && !nodes.has(bId)) nodes.set(bId, {id:bId, label:bLabel, group:r.B_TYPE||'Default'});
                if(aId && bId) edges.push({from:aId, to:bId, label:r.RELACION||'', arrows:'to'});
            });
            network = new vis.Network(document.getElementById('network-container'), {
                nodes: new vis.DataSet(Array.from(nodes.values())), edges: new vis.DataSet(edges)
            }, { nodes: { shape: 'dot', font: { face: 'Segoe UI' } }, physics: { stabilization: false } });
            network.on("click", p => {
                if(p.nodes.length) {
                    const n = nodes.get(p.nodes[0]);
                    selectedNodeData = n;
                    document.getElementById('canvasNodeLabel').innerText = n.label;
                    document.getElementById('canvasNodeId').innerText = n.id;
                    new bootstrap.Offcanvas(document.getElementById('nodeOffcanvas')).show();
                }
            });
        }

        const numCol = cols.find(c => ['CANTIDAD','TOTAL','SCORE','PRECIO','STOCK'].some(k => c.includes(k)));
        const lblCol = cols.find(c => ['DESCRIPCION','NAME','EQUIPO'].some(k => c.includes(k))) || cols[0];
        if (numCol && rows.length && document.getElementById('mainChart')) {
            new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'bar',
                data: { labels: rows.map(r=>String(r[lblCol]).substring(0,15)), datasets: [{ label: numCol, data: rows.map(r=>parseFloat(r[numCol])||0), backgroundColor: '#3498db' }] },
                options: { maintainAspectRatio: false }
            });
        }
    {% endif %}

    function exportCSV() {
        if (typeof rows === 'undefined' || !rows.length) return alert("Sin datos");
        const headers = cols.join(",");
        const csvRows = rows.map(row => cols.map(c => `"${String(row[c]||'').replace(/"/g,'""')}"`).join(","));
        const blob = new Blob(["\uFEFF" + [headers, ...csvRows].join("\r\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
        link.download = `nexus_export_${new Date().toISOString().slice(0,10)}.csv`; link.click();
    }

    function downloadGraphPNG() {
        if (!network) return alert("No hay grafo visible");
        const canvas = document.getElementById('network-container').getElementsByTagName('canvas')[0];
        const temp = document.createElement('canvas'); temp.width = canvas.width; temp.height = canvas.height;
        const ctx = temp.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0,0,temp.width,temp.height);
        ctx.drawImage(canvas, 0, 0);
        const link = document.createElement('a'); link.href = temp.toDataURL("image/png");
        link.download = "grafo.png"; link.click();
    }

    function setFocusFromCanvas() { if (selectedNodeData) updateSearchParam(selectedNodeData.id, selectedNodeData.label); }

    // --- IA (MISMA LOGICA) ---
    const PROVIDERS = { openai: { url: "https://api.openai.com/v1/chat/completions", model: "gpt-4o" }, groq: { url: "https://api.groq.com/openai/v1/chat/completions", model: "llama3-70b-8192" }, ollama: { url: "http://localhost:11434/v1/chat/completions", model: "llama3" } };
    let aiConfig = { provider: 'openai', baseUrl: PROVIDERS.openai.url, model: PROVIDERS.openai.model, key: '' };
    let chatHistory = [{role: "system", content: "Eres un experto industrial."}];
    let availableTools = null;
    function updateProviderSettings() { const p = document.getElementById('aiProviderSelect').value; if(PROVIDERS[p]) { document.getElementById('aiBaseUrl').value = PROVIDERS[p].url; document.getElementById('aiModelName').value = PROVIDERS[p].model; } }
    function triggerAiTool(name, id) { new bootstrap.Modal(document.getElementById('aiModal')).show(); let ctx = ""; if(tomSelectInstance && tomSelectInstance.getValue()) ctx = ` sobre "${tomSelectInstance.getValue()}"`; document.getElementById('userPrompt').value = `Usa "${name}"${ctx} y explica.`; }
    function saveAiConfig() { aiConfig = { provider: document.getElementById('aiProviderSelect').value, baseUrl: document.getElementById('aiBaseUrl').value, model: document.getElementById('aiModelName').value, key: document.getElementById('aiApiKey').value }; localStorage.setItem("ai_config", JSON.stringify(aiConfig)); bootstrap.Collapse.getInstance(document.getElementById('configPanel'))?.hide(); }
    function loadTools() { if(!availableTools) fetch('/api/ai/tools').then(r=>r.json()).then(d=>availableTools=d); }
    function handleEnter(e) { if(e.key==='Enter') sendPrompt(); }
    async function sendPrompt() {
        const inp = document.getElementById('userPrompt'); if(!inp.value.trim()) return;
        appendMessage('user', inp.value); chatHistory.push({role:'user', content:inp.value}); inp.value=''; const tid = showTyping();
        try {
            const res = await fetch("/api/openai_proxy", { method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${aiConfig.key}`,"x-base-url":aiConfig.baseUrl}, body:JSON.stringify({model:aiConfig.model, messages:chatHistory, tools:availableTools})});
            const data = await res.json(); if(data.error) throw new Error(JSON.stringify(data.error));
            const msg = data.choices[0].message; chatHistory.push(msg); removeTyping(tid);
            if(msg.tool_calls) {
                appendMessage('assistant', '<i>游댍 Ejecutando...</i>', true);
                for(const tc of msg.tool_calls) {
                    let args = {}; try { args=JSON.parse(tc.function.arguments); } catch(e){}
                    const tRes = await fetch('/api/execute', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query_id:tc.function.name, param:args.param})});
                    const tData = await tRes.json(); chatHistory.push({role:'tool', tool_call_id:tc.id, name:tc.function.name, content:JSON.stringify(tData).slice(0, 2000)});
                }
                showTyping();
                const res2 = await fetch("/api/openai_proxy", { method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${aiConfig.key}`,"x-base-url":aiConfig.baseUrl}, body:JSON.stringify({model:aiConfig.model, messages:chatHistory})});
                const data2 = await res2.json(); removeTyping(); appendMessage('assistant', data2.choices[0].message.content); chatHistory.push(data2.choices[0].message);
            } else { appendMessage('assistant', msg.content); }
        } catch(e) { removeTyping(); appendMessage('system', "Error: "+e.message); }
    }
    function appendMessage(role, text, temp) {
        const div = document.createElement('div'); div.className = `d-flex align-items-start mb-3 ${role==='user'?'justify-content-end':''}`;
        div.innerHTML = `<div class="${role==='user'?'bg-primary text-white':'bg-white border'} rounded p-3 shadow-sm" style="max-width:85%;">${text}</div>`;
        document.getElementById('chatArea').append(div);
    }
    function showTyping() { const id='t-'+Date.now(); appendMessage('system', '<div id="'+id+'">...</div>'); return id; }
    function removeTyping(id) { if(id) document.getElementById(id)?.parentElement?.parentElement?.remove(); }
</script>
{% endblock %}