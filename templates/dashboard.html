{% extends "base.html" %}

{% block content %}
<style>
    /* --- TEMA VISUAL: NEXUS STYLE --- */
    :root {
        --sidebar-bg: #2c3e50;
        --sidebar-width: 280px;
        --header-height: 60px;
        --primary-accent: #3498db;
        --bg-body: #f4f6f9;
        --text-dark: #333;
        --text-light: #ecf0f1;
        --border-color: #dee2e6;
        --folder-icon-color: #f1c40f;
    }

    body {
        background-color: var(--bg-body);
        font-family: 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
        overflow: hidden;
    }

    /* --- LAYOUT --- */
    .app-container { display: flex; height: 100vh; width: 100vw; }

    /* --- SIDEBAR --- */
    .sidebar {
        width: var(--sidebar-width);
        background-color: var(--sidebar-bg);
        color: var(--text-light);
        display: flex; flex-direction: column;
        transition: transform 0.3s ease;
        z-index: 1050; flex-shrink: 0;
    }

    .sidebar-brand {
        padding: 15px 20px;
        background-color: rgba(0,0,0,0.2);
        border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .brand-title { font-weight: 700; font-size: 1.1rem; line-height: 1.2; }
    .brand-subtitle { font-size: 0.75rem; opacity: 0.7; font-family: monospace; }

    .sidebar-menu { flex-grow: 1; overflow-y: auto; padding-top: 10px; }

    .nav-header {
        font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px;
        color: rgba(255,255,255,0.5); padding: 15px 20px 5px 20px; font-weight: 600;
    }

    .nav-item {
        padding: 10px 20px; color: #bdc3c7; text-decoration: none;
        display: flex; align-items: center; border-left: 3px solid transparent;
        cursor: pointer; transition: all 0.2s; font-size: 0.9rem;
    }
    .nav-item:hover, .nav-item.active {
        background-color: rgba(255,255,255,0.05); color: #fff; border-left-color: var(--primary-accent);
    }
    .nav-item i { width: 25px; text-align: center; margin-right: 10px; }

    .sidebar-footer {
        padding: 15px 20px; background-color: rgba(0,0,0,0.3);
        font-size: 0.8rem; border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Enlace del autor */
    .author-link { color: #fff; text-decoration: none; transition: color 0.2s; }
    .author-link:hover { color: var(--primary-accent); text-decoration: underline; }

    /* --- CONTENIDO --- */
    .main-content {
        flex-grow: 1; display: flex; flex-direction: column;
        overflow: hidden; position: relative; background-color: #fff;
    }

    .top-header {
        height: var(--header-height); padding: 0 20px;
        display: flex; align-items: center; justify-content: space-between;
        border-bottom: 1px solid var(--border-color); background-color: #fff;
    }
    .header-title {
        font-size: 1.25rem; color: #5f6e82; font-weight: 600;
        display: flex; align-items: center; gap: 10px;
    }

    .filters-bar {
        padding: 15px 20px 15px 20px; background-color: #fcfcfc;
        border-bottom: 1px solid var(--border-color);
    }
    .filter-tabs { display: flex; gap: 30px; margin-bottom: 10px;}
    .filter-tab {
        padding-bottom: 10px; font-size: 0.9rem; color: #7f8c8d;
        font-weight: 600; text-transform: uppercase;
        border-bottom: 3px solid transparent; cursor: pointer;
    }
    .filter-tab.active { color: #2c3e50; border-bottom-color: #2c3e50; }

    .workspace {
        flex-grow: 1; overflow-y: auto; padding: 20px; background-color: var(--bg-body);
    }

    /* --- ESTILOS DE BÚSQUEDA --- */
    .query-indicator {
        font-size: 0.75rem; color: var(--primary-accent); 
        font-weight: bold; text-transform: uppercase; margin-bottom: 5px;
        display: block;
    }

    /* --- TABLA DINÁMICA --- */
    .tree-table {
        background: #fff; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        width: 100%; border-collapse: collapse; white-space: nowrap;
    }
    .tree-table th {
        background-color: #fff; border-bottom: 1px solid #eee;
        padding: 12px 15px; text-align: left; font-weight: 700;
        font-size: 0.85rem; color: #333; text-transform: uppercase;
    }
    .tree-table td {
        padding: 10px 15px; border-bottom: 1px solid #f0f0f0;
        font-size: 0.9rem; color: #555; vertical-align: middle;
    }
    .tree-table tr:hover { background-color: #f8f9fa; }
    
    .node-icon { color: var(--folder-icon-color); margin-right: 8px; }
    
    .col-numeric { text-align: right; font-family: 'Roboto Mono', monospace; color: #2c3e50; }
    .col-badge span { font-size: 0.75rem; padding: 3px 8px; border-radius: 12px; }
    .col-main { font-weight: 600; color: #2c3e50; }

    /* --- EXTRAS --- */
    #network-container { width: 100%; height: 600px; background: #fff; border: 1px solid #ddd; }
    .ts-dropdown, .ts-control { z-index: 2000 !important; }

    @media (max-width: 991px) {
        .sidebar { position: fixed; height: 100%; transform: translateX(-100%); }
        .sidebar.show { transform: translateX(0); }
        .overlay-backdrop {
            display: none; position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.5); z-index: 1040;
        }
        .overlay-backdrop.show { display: block; }
        .tree-table { display: block; overflow-x: auto; }
    }
</style>

<div class="app-container">
    <div class="overlay-backdrop" id="mobileBackdrop" onclick="toggleSidebar()"></div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <div class="d-flex justify-content-between align-items-center">
                <!-- TÍTULO CAMBIADO A NEXUS 1 -->
                <div><div class="brand-title">Nexus 1</div><div class="brand-subtitle text-white-50">v2024.34.6</div></div>
                <button class="btn btn-sm text-white d-lg-none" onclick="toggleSidebar()"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="mt-2 text-white-50 small" style="font-size: 0.7rem;">Industrial Graph Analytics</div>
        </div>

        <nav class="sidebar-menu">
            <a href="/" class="nav-item"><i class="fa-solid fa-house"></i> Inicio</a>
            {% for category, queries in categorized_queries %}
            <div class="nav-header">{{ category }}</div>
            {% for q in queries %}
            <div class="nav-item" onclick="selectQuery('{{ q.id }}', '{{ q.title }}')">
                <i class="fa-solid {{ q.icon }}"></i> <span class="text-truncate">{{ q.title }}</span>
            </div>
            {% endfor %}
            {% endfor %}
            <div class="nav-header">HERRAMIENTAS IA</div>
            {% for category, tools in ai_tools_groups %}
                {% for t in tools %}
                <div class="nav-item" style="color: #a29bfe;" onclick="triggerAiTool('{{ t.title }}', '{{ t.id }}')">
                    <i class="fa-solid {{ t.icon }}"></i> {{ t.title }}
                </div>
                {% endfor %}
            {% endfor %}
        </nav>

        <div class="sidebar-footer">
            <div class="d-flex align-items-center">
                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2" style="width:30px; height:30px;">
                    <i class="fa-solid fa-user text-white" style="font-size: 0.8rem;"></i>
                </div>
                <div>
                    <!-- AUTOR CON ENLACE -->
                    <a href="https://angelurbinacv.netlify.app/" target="_blank" class="author-link">
                        <div class="fw-bold">Angel A. Urbina</div>
                    </a>
                    <div style="font-size: 0.7rem; opacity: 0.6;">Autor / Developer</div>
                </div>
            </div>
        </div>
    </aside>

    <!-- CONTENIDO -->
    <main class="main-content">
        <header class="top-header">
            <div class="header-title">
                <button class="btn btn-link text-dark d-lg-none me-2 p-0" onclick="toggleSidebar()"><i class="fa-solid fa-bars fa-lg"></i></button>
                <i class="fa-solid fa-folder-tree text-secondary"></i>
                <span id="headerTitleText">{% if results %} {{ results.query_title }} {% else %} Selecciona una consulta {% endif %}</span>
            </div>
            <div class="d-flex align-items-center gap-3">
                <img src="https://flagcdn.com/w20/es.png" alt="ES" class="rounded-1" style="opacity: 0.8;">
                <div class="vr h-50 mx-1"></div>
                <i class="fa-regular fa-bell text-secondary cursor-pointer"></i>
                <i class="fa-regular fa-user text-secondary cursor-pointer"></i>
            </div>
        </header>

        <!-- BARRA DE ACCIÓN Y FILTROS -->
        <div class="filters-bar">
            <div class="row">
                <!-- Tabs Visuales -->
                <div class="col-md-7">
                    <div class="filter-tabs">
                        <div class="filter-tab active"><i class="fa-solid fa-globe me-1"></i> FILTROS <div style="font-size: 0.7rem; color: #95a5a6; font-weight: normal; margin-top:2px;">plant es <strong>03(022)</strong></div></div>
                        <div class="filter-tab"><i class="fa-solid fa-layer-group me-1"></i> VISTA</div>
                    </div>
                </div>
                
                <!-- FORMULARIO DE EJECUCIÓN -->
                <div class="col-md-5">
                     <form id="searchForm" action="/query" method="POST">
                        <input type="hidden" name="query_id" id="hiddenQueryId" value="{{ current_query | default(value='M01') }}">
                        
                        <span class="query-indicator" id="queryIndicator">
                            <i class="fa-solid fa-wrench me-1"></i> 
                            <span id="queryNameLabel">{% if results %}{{ results.query_title }}{% else %}Selecciona en el menú...{% endif %}</span>
                        </span>

                        <div class="d-flex gap-2">
                            <div style="flex-grow: 1;">
                                <select id="select-param" name="param" placeholder="Parámetro (opcional)..." style="width: 100%;"></select>
                            </div>
                            <button type="submit" class="btn btn-primary fw-bold px-3">
                                <i class="fa-solid fa-bolt me-1"></i> EJECUTAR
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="workspace">
            <!-- Barra de Herramientas de la Tabla -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex gap-2">
                    <span class="badge bg-white text-dark border p-2">Estado: <strong>Conectado</strong></span>
                </div>
                <div class="btn-group shadow-sm">
                    <button class="btn btn-sm btn-light border" title="Exportar CSV" onclick="exportCSV()"><i class="fa-solid fa-file-csv text-success"></i> CSV</button>
                    <button class="btn btn-sm btn-light border" title="Descargar PNG" onclick="downloadGraphPNG()"><i class="fa-solid fa-image text-primary"></i> PNG</button>
                    <button class="btn btn-sm btn-light border" title="Gráficos" data-bs-toggle="modal" data-bs-target="#statsModal"><i class="fa-solid fa-chart-pie text-danger"></i> Stats</button>
                </div>
            </div>

            {% if results %}
                {% if results.is_graph %}
                    <!-- VISTA GRAFO -->
                    <div class="bg-white p-2 rounded shadow-sm border">
                        <div id="network-container"></div>
                        <div class="text-center small text-muted mt-2"><i class="fa-solid fa-circle-info"></i> Usa el scroll para zoom y arrastra los nodos.</div>
                    </div>
                {% else %}
                    <!-- VISTA TABLA DINÁMICA -->
                    <div class="table-responsive bg-white rounded shadow-sm border" style="min-height: 400px;">
                        <table class="tree-table">
                            <thead>
                                <tr>
                                    {% for col in results.columns %}
                                        <th class="{% if 'PRECIO' in col or 'COSTO' in col or 'STOCK' in col or 'CANT' in col or 'TOTAL' in col %}text-end{% endif %}">
                                            {{ col | replace(from="_", to=" ") }}
                                        </th>
                                    {% endfor %}
                                    <th style="width: 50px;"></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in results.rows %}
                                
                                {% set row_id = row.ID | default(value=row.A_ID | default(value=row.CODIGO | default(value=row.MATERIAL | default(value="")))) %}
                                {% set row_label = row.NAME | default(value=row.A_LABEL | default(value=row.DESCRIPCION | default(value=row.EQUIPO | default(value="")))) %}

                                <tr>
                                    {% for col in results.columns %}
                                        {% set val = row[col] %}
                                        
                                        {% if loop.first %}
                                            <td class="col-main">
                                                {% if row.B_TYPE and ("Equipo" in row.B_TYPE or "Ubicacion" in row.B_TYPE) %}
                                                    <i class="fa-regular fa-folder node-icon"></i>
                                                {% else %}
                                                    <i class="fa-solid fa-cube text-secondary me-2 small"></i>
                                                {% endif %}
                                                {{ val }}
                                            </td>
                                        {% elif 'TYPE' in col or 'TIPO' in col or 'STATUS' in col or 'ESTADO' in col %}
                                            <td class="col-badge"><span class="badge bg-light text-secondary border">{{ val }}</span></td>
                                        {% elif 'PRECIO' in col or 'COSTO' in col or 'STOCK' in col or 'CANT' in col or 'TOTAL' in col %}
                                            <td class="col-numeric">{{ val }}</td>
                                        {% else %}
                                            <td>{{ val }}</td>
                                        {% endif %}
                                    {% endfor %}

                                    <td class="text-center">
                                        <div class="dropdown">
                                            <button class="btn btn-link btn-sm text-secondary p-0" data-bs-toggle="dropdown"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                                            <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                                <li><a class="dropdown-item small" href="#"><i class="fa-solid fa-eye me-2"></i> Ver detalle</a></li>
                                                {% if row_id %}
                                                <li><a class="dropdown-item small" href="#" onclick="updateSearchParam('{{ row_id }}', '{{ row_label }}')"><i class="fa-solid fa-filter me-2"></i> Usar como parámetro</a></li>
                                                {% endif %}
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                                <tr style="background-color: #fcfcfc; font-weight: bold; border-top: 2px solid #e9ecef;">
                                    <td class="ps-3 text-muted">Total: {{ results.rows | length }} filas</td>
                                    <td colspan="{{ results.columns | length }}"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                {% endif %}
            {% else %}
                <div class="d-flex flex-column align-items-center justify-content-center h-75 text-muted">
                    <div class="bg-white p-5 rounded-circle shadow-sm mb-4"><i class="fa-solid fa-magnifying-glass-chart fa-4x" style="color: #e0e0e0;"></i></div>
                    <h4 class="fw-light">Listo para buscar</h4>
                    <p class="small text-center">1. Selecciona una consulta en el menú lateral.<br>2. Escribe un parámetro (si hace falta).<br>3. Pulsa <b>EJECUTAR</b>.</p>
                </div>
            {% endif %}
        </div>
    </main>
</div>

<!-- MODALS -->
<div class="modal fade" id="statsModal" tabindex="-1"><div class="modal-dialog modal-lg"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Estadísticas</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><canvas id="mainChart" style="max-height: 400px;"></canvas></div></div></div></div>

<div class="modal fade" id="aiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content border-0 shadow-lg" style="height: 80vh;">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title fs-6"><i class="fa-solid fa-brain me-2 text-info"></i> Asistente IA</h5>
                <div class="ms-auto"><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            </div>
            <div class="modal-body bg-light p-3" id="chatArea" style="overflow-y: auto;">
                <div class="d-flex mb-3"><div class="bg-white border rounded p-3 shadow-sm">Hola, ¿en qué te ayudo?</div></div>
            </div>
            <div class="modal-footer p-2 bg-white"><div class="input-group"><input type="text" id="userPrompt" class="form-control border-0 bg-light" placeholder="Pregunta..." onkeypress="handleEnter(event)"><button class="btn btn-primary" onclick="sendPrompt()"><i class="fa-solid fa-paper-plane"></i></button></div></div>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-end shadow" tabindex="-1" id="nodeOffcanvas" data-bs-backdrop="false">
    <div class="offcanvas-header bg-primary text-white"><h5 class="fw-bold">Detalle</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button></div>
    <div class="offcanvas-body"><h5 id="canvasNodeLabel" class="fw-bold"></h5><code id="canvasNodeId" class="d-block mb-3 text-muted"></code><button class="btn btn-primary w-100 mb-2" onclick="setFocusFromCanvas()">Usar como filtro</button></div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); document.getElementById('mobileBackdrop').classList.toggle('show'); }
    
    function selectQuery(id, title) {
        document.getElementById('hiddenQueryId').value = id;
        document.getElementById('headerTitleText').innerText = title;
        document.getElementById('queryNameLabel').innerText = title;
        if(tomSelectInstance) { tomSelectInstance.clear(); tomSelectInstance.focus(); }
        if(window.innerWidth < 992) toggleSidebar();
    }

    let tomSelectInstance;
    document.addEventListener("DOMContentLoaded", function(){
        tomSelectInstance = new TomSelect("#select-param", {
            valueField: 'id', labelField: 'title', searchField: ['title', 'id'],
            preload: 'focus', placeholder: 'Escribe ID o Nombre...',
            create: false, maxItems: 1, plugins: ['dropdown_input'],
            onItemAdd: function() { this.setTextboxValue(''); },
            load: function(query, callback) {
                fetch('/api/search?q=' + encodeURIComponent(query || ''))
                    .then(r => r.json()).then(json => callback(json)).catch(() => callback());
            },
            render: {
                option: (item, escape) => `<div class="py-2 px-3 border-bottom"><div class="fw-bold text-dark">${escape(item.title)}</div><div class="small text-muted">${escape(item.label || 'Nodo')}</div></div>`,
                item: (item, escape) => `<div>${escape(item.title)}</div>`
            }
        });
        {% if current_param %}
            setTimeout(() => { tomSelectInstance.addOption({id: "{{current_param}}", title: "{{current_param_label}}"}); tomSelectInstance.setValue("{{current_param}}"); }, 100);
        {% endif %}
    });

    function updateSearchParam(id, label) {
        if(!tomSelectInstance) return;
        tomSelectInstance.clear(true); tomSelectInstance.clearOptions();
        tomSelectInstance.addOption({id:id, title:label}); tomSelectInstance.setValue(id);
    }

    {% if results %}
        const rows = {{ results.rows | json_encode() | safe }};
        const cols = {{ results.columns | json_encode() | safe }};
        const isGraphQuery = {{ results.is_graph | json_encode() }};
        let network = null, selectedNodeData = null;

        if (isGraphQuery && document.getElementById('network-container')) {
            const nodes = new Map(), edges = [];
            rows.forEach(r => {
                const keys = Object.keys(r);
                const aId = r[keys.find(k => k.includes('A_ID') || k==='ID')] || r.ID;
                const bId = r[keys.find(k => k.includes('B_ID'))];
                const aLabel = r[keys.find(k => k.includes('A_LABEL') || k==='NAME')] || aId;
                
                if(aId && !nodes.has(aId)) nodes.set(aId, {id:aId, label:aLabel, group:r.A_TYPE||'Default'});
                if(bId && !nodes.has(bId)) nodes.set(bId, {id:bId, label:bId, group:r.B_TYPE||'Default'});
                if(aId && bId) edges.push({from:aId, to:bId, arrows:'to'});
            });
            network = new vis.Network(document.getElementById('network-container'), {
                nodes: new vis.DataSet(Array.from(nodes.values())), edges: new vis.DataSet(edges)
            }, { nodes: { shape: 'dot', font: { face: 'Segoe UI' } }, physics: { stabilization: false } });
            
            network.on("click", p => {
                if(p.nodes.length) {
                    const n = nodes.get(p.nodes[0]);
                    selectedNodeData = n;
                    document.getElementById('canvasNodeLabel').innerText = n.label;
                    document.getElementById('canvasNodeId').innerText = n.id;
                    new bootstrap.Offcanvas(document.getElementById('nodeOffcanvas')).show();
                }
            });
        }

        const numCol = cols.find(c => ['CANTIDAD','TOTAL','SCORE','PRECIO','STOCK'].some(k => c.includes(k)));
        const lblCol = cols.find(c => ['DESCRIPCION','NAME','EQUIPO'].some(k => c.includes(k))) || cols[0];
        if (numCol && rows.length && document.getElementById('mainChart')) {
            new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'bar',
                data: { labels: rows.map(r=>String(r[lblCol]).substring(0,15)), datasets: [{ label: numCol, data: rows.map(r=>parseFloat(r[numCol])||0), backgroundColor: '#3498db' }] },
                options: { maintainAspectRatio: false }
            });
        }
    {% endif %}

    function exportCSV() {
        if (typeof rows === 'undefined' || !rows.length) return alert("Sin datos");
        const headers = cols.join(",");
        const csvRows = rows.map(row => cols.map(c => `"${String(row[c]||'').replace(/"/g,'""')}"`).join(","));
        const blob = new Blob(["\uFEFF" + [headers, ...csvRows].join("\r\n")], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
        link.download = `nexus_export_${new Date().toISOString().slice(0,10)}.csv`; link.click();
    }

    function downloadGraphPNG() {
        if (!network) return alert("No hay grafo visible");
        const canvas = document.getElementById('network-container').getElementsByTagName('canvas')[0];
        const temp = document.createElement('canvas'); temp.width = canvas.width; temp.height = canvas.height;
        const ctx = temp.getContext('2d'); ctx.fillStyle = '#fff'; ctx.fillRect(0,0,temp.width,temp.height);
        ctx.drawImage(canvas, 0, 0);
        const link = document.createElement('a'); link.href = temp.toDataURL("image/png");
        link.download = "grafo.png"; link.click();
    }

    function setFocusFromCanvas() { if (selectedNodeData) updateSearchParam(selectedNodeData.id, selectedNodeData.label); }

    // IA Logic
    const PROVIDERS = { openai: { url: "https://api.openai.com/v1/chat/completions", model: "gpt-4o" }, groq: { url: "https://api.groq.com/openai/v1/chat/completions", model: "llama3-70b-8192" }, ollama: { url: "http://localhost:11434/v1/chat/completions", model: "llama3" } };
    let aiConfig = { provider: 'openai', baseUrl: PROVIDERS.openai.url, model: PROVIDERS.openai.model, key: '' };
    let chatHistory = [{role: "system", content: "Eres un experto industrial."}];
    let availableTools = null;
    function saveAiConfig() { aiConfig = { provider: document.getElementById('aiProviderSelect').value, baseUrl: document.getElementById('aiBaseUrl').value, model: document.getElementById('aiModelName').value, key: document.getElementById('aiApiKey').value }; localStorage.setItem("ai_config", JSON.stringify(aiConfig)); }
    function loadTools() { fetch('/api/ai/tools').then(r=>r.json()).then(d=>availableTools=d); }
    function handleEnter(e) { if(e.key==='Enter') sendPrompt(); }
    async function sendPrompt() {
        const inp = document.getElementById('userPrompt'); if(!inp.value.trim()) return;
        const div = document.createElement('div'); div.className = "d-flex justify-content-end mb-2"; div.innerHTML = `<div class="bg-primary text-white p-2 rounded">${inp.value}</div>`; document.getElementById('chatArea').append(div);
        chatHistory.push({role:'user', content:inp.value}); inp.value=''; 
        try {
            const res = await fetch("/api/openai_proxy", { method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${aiConfig.key}`,"x-base-url":aiConfig.baseUrl}, body:JSON.stringify({model:aiConfig.model, messages:chatHistory, tools:availableTools})});
            const data = await res.json();
            if(data.choices && data.choices[0].message.tool_calls) {
                const tc = data.choices[0].message.tool_calls[0];
                let args = JSON.parse(tc.function.arguments);
                const tRes = await fetch('/api/execute', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query_id:tc.function.name, param:args.param})});
                const tData = await tRes.json();
                chatHistory.push(data.choices[0].message);
                chatHistory.push({role:'tool', tool_call_id:tc.id, name:tc.function.name, content:JSON.stringify(tData).slice(0, 500)});
                const res2 = await fetch("/api/openai_proxy", { method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${aiConfig.key}`,"x-base-url":aiConfig.baseUrl}, body:JSON.stringify({model:aiConfig.model, messages:chatHistory})});
                const data2 = await res2.json();
                const div2 = document.createElement('div'); div2.className = "d-flex mb-2"; div2.innerHTML = `<div class="bg-white border p-2 rounded">${data2.choices[0].message.content}</div>`; document.getElementById('chatArea').append(div2);
            } else {
                const div2 = document.createElement('div'); div2.className = "d-flex mb-2"; div2.innerHTML = `<div class="bg-white border p-2 rounded">${data.choices[0].message.content}</div>`; document.getElementById('chatArea').append(div2);
            }
        } catch(e) { console.error(e); }
    }
</script>
{% endblock %}