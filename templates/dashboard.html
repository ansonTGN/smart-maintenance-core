{% extends "base.html" %}

{% block content %}
<style>
    /* CORRECCIN VISUAL: Desplegable por encima de todo */
    .ts-dropdown, .ts-control {
        z-index: 1060 !important; 
    }
    .ts-dropdown {
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        border: 1px solid #dee2e6;
        border-radius: 6px;
    }
    .ts-control {
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.375rem 0.75rem;
        background-color: white;
    }
    /* Estilo para el bot贸n de selecci贸n en la tabla */
    .btn-select-target {
        opacity: 0.3;
        transition: opacity 0.2s;
    }
    tr:hover .btn-select-target {
        opacity: 1;
    }
    #network-container {
        width: 100%;
        height: 100%;
        min-height: 500px;
    }
</style>

<!-- BARRA DE NAVEGACIN -->
<nav class="navbar navbar-dark shadow-sm" style="background: linear-gradient(90deg, #1e293b 0%, #334155 100%); flex-shrink: 0; z-index: 1040;">
    <div class="container-fluid px-4">
        <a class="navbar-brand d-flex align-items-center gap-2" href="#">
            <i class="fa-solid fa-network-wired text-info"></i> 
            <div>
                <div class="lh-1 fw-bold font-monospace">NEO4J ANALYTICS</div>
                <div style="font-size: 0.65rem; opacity: 0.7; letter-spacing: 1px;">PETROCHEM SYSTEMS</div>
            </div>
        </a>
        
        <button class="btn btn-outline-light d-lg-none me-auto ms-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarOffcanvas">
            <i class="fa-solid fa-bars"></i>
        </button>

        <div class="d-none d-lg-flex align-items-center bg-black bg-opacity-25 px-3 py-1 rounded-pill border border-secondary border-opacity-25 ms-auto">
            <span class="d-flex align-items-center text-light small fw-bold font-monospace">
                <i class="fa-solid fa-circle text-success me-2" style="font-size: 0.5rem; box-shadow: 0 0 8px #2ecc71;"></i>
                {{ db_host | default(value="Conectado") }}
            </span>
        </div>
        <a href="/" class="btn btn-outline-danger btn-sm rounded-pill px-3 py-0 ms-3" style="line-height: 28px;">
            <i class="fa-solid fa-power-off me-2"></i>Salir
        </a>
    </div>
</nav>

<!-- ESTRUCTURA PRINCIPAL -->
<div class="container-fluid d-flex flex-column overflow-hidden" style="height: calc(100vh - 56px);">
    <div class="row h-100 flex-nowrap"> 
        
        <!-- SIDEBAR (IZQUIERDA) -->
        <div class="offcanvas-lg offcanvas-start col-lg-3 h-100 p-0 bg-white border-end d-flex flex-column shadow-sm" 
             tabindex="-1" id="sidebarOffcanvas" style="z-index: 1045;">
            
            <div class="offcanvas-header bg-light border-bottom d-lg-none">
                <h5 class="offcanvas-title fw-bold text-secondary">Panel de Control</h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" data-bs-target="#sidebarOffcanvas"></button>
            </div>

            <ul class="nav nav-tabs nav-justified bg-white border-bottom flex-shrink-0" id="sidebarTabs" role="tablist">
                <li class="nav-item"><button class="nav-link active small fw-bold text-uppercase py-3 rounded-0 border-top-0 border-start-0" id="manual-tab" data-bs-toggle="tab" data-bs-target="#manual-pane">Manual</button></li>
                <li class="nav-item"><button class="nav-link small fw-bold text-uppercase py-3 rounded-0 border-top-0 border-end-0" id="ai-tab" data-bs-toggle="tab" data-bs-target="#ai-pane" style="color: #6f42c1;">Apps IA</button></li>
            </ul>
            
            <div class="tab-content flex-grow-1 overflow-auto bg-light">
                <!-- PESTAA MANUAL -->
                <div class="tab-pane fade show active p-3" id="manual-pane">
                    <form action="/query" method="post" id="queryForm">
                        <div class="mb-4 bg-white p-3 rounded shadow-sm border">
                            <label class="form-label fw-bold small text-dark d-flex justify-content-between">
                                OBJETO OBJETIVO 
                                <span class="badge bg-info text-dark" id="target-badge" style="display:none;">Seleccionado</span>
                            </label>
                            
                            <!-- SELECTOR (Se llena via JS) -->
                            <div style="position: relative;">
                                <select id="select-param" name="param" autocomplete="off" placeholder="Escribe para buscar..."></select>
                            </div>
                            
                            <div class="form-text small mt-1 text-muted fst-italic">
                                <i class="fa-solid fa-circle-info me-1"></i> Busca ID o selecciona del grafo/tabla.
                            </div>
                        </div>

                        <label class="form-label fw-bold small text-dark mb-2 px-1 text-uppercase">Consultas Disponibles</label>
                        <div class="accordion accordion-flush shadow-sm rounded border overflow-hidden bg-white" id="queriesAccordion">
                            {% for category, queries in categorized_queries %}
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading{{ loop.index }}">
                                    <button class="accordion-button collapsed fw-bold py-2 bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" style="font-size: 0.85rem; color: #34495e;">
                                        <i class="fa-solid fa-folder me-2 text-primary opacity-50"></i> {{ category }}
                                        <span class="badge bg-secondary bg-opacity-10 text-secondary ms-auto rounded-pill" style="font-size: 0.65rem;">{{ queries | length }}</span>
                                    </button>
                                </h2>
                                <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" data-bs-parent="#queriesAccordion">
                                    <div class="accordion-body p-0">
                                        <div class="list-group list-group-flush">
                                            {% for q in queries %}
                                            <label class="list-group-item list-group-item-action d-flex align-items-center gap-2 border-0 py-2 ps-4" style="font-size: 0.8rem; cursor: pointer;">
                                                <input class="form-check-input flex-shrink-0" type="radio" name="query_id" value="{{ q.id }}" {% if current_query == q.id %}checked{% endif %} required>
                                                <div class="w-100" title="{{ q.description }}">
                                                    <i class="fa-solid {{ q.icon }} me-1 opacity-50" style="width: 15px;"></i> {{ q.title }}
                                                </div>
                                            </label>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <div class="d-grid mt-4 pb-4">
                            <button type="submit" class="btn btn-primary fw-bold shadow py-2"><i class="fa-solid fa-bolt me-2"></i> EJECUTAR</button>
                        </div>
                    </form>
                    {% if error %}
                    <div class="alert alert-danger mt-3 small shadow-sm border-0">{{ error }}</div>
                    {% endif %}
                </div>

                <!-- PESTAA IA -->
                <div class="tab-pane fade p-3" id="ai-pane">
                    <div class="alert alert-info border-0 shadow-sm small mb-3 bg-white">
                        <div class="d-flex">
                            <i class="fa-solid fa-wand-magic-sparkles fs-4 me-3 mt-1 text-info"></i>
                            <div><strong>Asistente IA</strong><br>Consultas en lenguaje natural.</div>
                        </div>
                    </div>
                    <div class="accordion accordion-flush shadow-sm rounded border overflow-hidden bg-white" id="aiAccordion">
                        {% for category, tools in ai_tools_groups %}
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="aiHeading{{ loop.index }}">
                                <button class="accordion-button collapsed fw-bold py-2 bg-white" type="button" data-bs-toggle="collapse" data-bs-target="#aiCollapse{{ loop.index }}" style="font-size: 0.85rem; color: #6f42c1;">
                                    <i class="fa-solid fa-layer-group me-2 opacity-50"></i> {{ category }}
                                    <span class="badge bg-light text-dark border ms-auto rounded-pill" style="font-size: 0.65rem;">{{ tools | length }}</span>
                                </button>
                            </h2>
                            <div id="aiCollapse{{ loop.index }}" class="accordion-collapse collapse show" data-bs-parent="#aiAccordion">
                                <div class="accordion-body p-0">
                                    <div class="list-group list-group-flush">
                                        {% for tool in tools %}
                                        <button type="button" onclick="triggerAiTool('{{ tool.title }}', '{{ tool.id }}')" class="list-group-item list-group-item-action d-flex align-items-center gap-2 border-0 py-3 ps-4" style="font-size: 0.8rem;">
                                            <div class="bg-light rounded-circle d-flex align-items-center justify-content-center border" style="width: 32px; height: 32px; flex-shrink: 0;">
                                                <i class="fa-solid {{ tool.icon }} text-primary"></i>
                                            </div>
                                            <div class="w-100 text-start">
                                                <div class="fw-bold text-dark">{{ tool.title }}</div>
                                            </div>
                                        </button>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="p-3 border-top bg-white flex-shrink-0 mt-auto">
                <div class="d-flex align-items-center p-2 rounded" style="color: #2c3e50;">
                    <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                        <i class="fa-solid fa-user-tie"></i>
                    </div>
                    <div class="lh-1">
                        <div class="small text-muted fw-bold text-uppercase" style="font-size: 0.65rem;">Sistema</div>
                        <div class="fw-bold text-dark">Graph Admin</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENIDO (DERECHA) -->
        <div class="col-12 col-lg-9 h-100 p-0 flex-grow-1 d-flex flex-column position-relative">
            {% if results %}
            <!-- Header Resultados -->
            <div class="bg-white px-4 py-3 border-bottom d-flex justify-content-between align-items-center shadow-sm flex-shrink-0" style="z-index: 10;">
                <div class="overflow-hidden">
                    <h5 class="mb-0 fw-bold text-primary text-truncate">{{ results.query_title }}</h5>
                    <div class="text-muted text-truncate" style="font-size: 0.75rem;">
                        <i class="fa-regular fa-clock me-1"></i>{{ results.timestamp }} 
                        <span class="mx-2">|</span> 
                        <i class="fa-solid fa-table-list me-1"></i>{{ results.rows | length }} res.
                    </div>
                </div>
                <div class="btn-group ms-2">
                    <button class="btn btn-sm btn-outline-primary fw-bold d-none d-md-inline-block" onclick="downloadGraphPNG()"><i class="fa-solid fa-camera me-1"></i> PNG</button>
                    <button class="btn btn-sm btn-outline-success fw-bold d-none d-md-inline-block" onclick="exportCSV()"><i class="fa-solid fa-file-csv me-1"></i> CSV</button>
                </div>
            </div>

            <!-- Tabs y Paneles -->
            <div class="d-flex flex-column flex-grow-1 overflow-hidden">
                <div class="card h-100 border-0 rounded-0 d-flex flex-column">
                    <div class="card-header bg-light border-bottom p-2 flex-shrink-0">
                        <ul class="nav nav-pills nav-fill gap-2" id="resultTabs" role="tablist">
                            <li class="nav-item"><button class="nav-link {% if results.is_graph %}active{% endif %} fw-bold small py-1" id="graph-tab" data-bs-toggle="tab" data-bs-target="#graph-pane"><i class="fa-solid fa-circle-nodes me-2"></i>Grafo</button></li>
                            <li class="nav-item"><button class="nav-link {% if not results.is_graph %}active{% endif %} fw-bold small py-1" id="table-tab" data-bs-toggle="tab" data-bs-target="#table-pane"><i class="fa-solid fa-table me-2"></i>Tabla</button></li>
                            <li class="nav-item"><button class="nav-link fw-bold small py-1" id="chart-tab" data-bs-toggle="tab" data-bs-target="#chart-pane"><i class="fa-solid fa-chart-simple me-2"></i>Stats</button></li>
                        </ul>
                    </div>

                    <div class="card-body p-0 position-relative flex-grow-1 overflow-hidden" style="background: #fcfcfc;">
                        <div class="tab-content h-100 w-100">
                            <!-- PANE GRAFO -->
                            <div class="tab-pane fade {% if results.is_graph %}show active{% endif %} h-100 w-100 position-relative" id="graph-pane">
                                <div id="network-container"></div>
                                <div class="position-absolute bottom-0 start-0 m-3 btn-group-vertical shadow-sm" style="z-index: 10;">
                                    <button class="btn btn-light border btn-sm" onclick="network.moveTo({scale: 1.5})"><i class="fa-solid fa-plus"></i></button>
                                    <button class="btn btn-light border btn-sm" onclick="network.fit()"><i class="fa-solid fa-compress"></i></button>
                                    <button class="btn btn-light border btn-sm" onclick="network.moveTo({scale: 0.5})"><i class="fa-solid fa-minus"></i></button>
                                </div>
                            </div>
                            
                            <!-- PANE TABLA -->
                            <div class="tab-pane fade {% if not results.is_graph %}show active{% endif %} h-100 p-0" id="table-pane" style="overflow: hidden;">
                                <div class="table-responsive h-100 w-100">
                                    <table class="table table-hover table-striped table-sm mb-0 align-middle small table-bordered">
                                        <thead class="table-dark sticky-top">
                                            <tr>
                                                <th class="text-center bg-secondary" style="width: 40px;">#</th>
                                                {% for col in results.columns %}
                                                <th class="text-uppercase px-3">{{ col }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in results.rows %}
                                            <tr>
                                                <td class="text-center text-muted">{{ loop.index }}</td>
                                                {% for col in results.columns %}
                                                <td class="px-2">
                                                    {% if row[col] != "-" and "Lista" not in row[col] %}
                                                        <div class="d-flex justify-content-between align-items-center">
                                                            <span class="text-dark">{{ row[col] }}</span>
                                                            
                                                            {# --- CORRECCIN 2: LGICA DE BOTN DE SELECCIN AMPLIADA --- #}
                                                            {# Se muestra si la columna contiene ID, CODIGO, TAG, EQUIPO, MATERIAL o PLANTA #}
                                                            {% if "ID" in col or "CODIGO" in col or "TAG" in col or "EQUIPO" in col or "MATERIAL" in col or "PLANTA" in col %}
                                                                <button class="btn btn-link btn-sm p-0 ms-2 btn-select-target" type="button" 
                                                                        onclick="updateSearchParam('{{ row[col] }}', '{{ row[col] }}')"
                                                                        title="Usar como Objetivo">
                                                                    <i class="fa-solid fa-crosshairs text-primary"></i>
                                                                </button>
                                                            {% endif %}
                                                        </div>
                                                    {% else %}
                                                        {{ row[col] }}
                                                    {% endif %}
                                                </td>
                                                {% endfor %}
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- PANE CHART -->
                            <div class="tab-pane fade h-100 w-100 p-4" id="chart-pane">
                                <div class="d-flex flex-column h-100">
                                    <h6 class="text-center text-secondary text-uppercase fw-bold mb-3" id="chart-title">An谩lisis de Datos</h6>
                                    <div style="flex-grow: 1; position: relative; width: 100%;">
                                        <canvas id="mainChart"></canvas>
                                    </div>
                                    <p class="text-center text-muted small mt-2" id="chart-msg"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <!-- EMPTY STATE -->
            <div class="h-100 d-flex flex-column justify-content-center align-items-center text-muted opacity-50 bg-light p-4 text-center">
                <div class="bg-white p-4 p-md-5 rounded-circle shadow-sm mb-4">
                    <i class="fa-solid fa-magnifying-glass-chart fa-3x fa-md-4x text-primary opacity-50"></i>
                </div>
                <h3 class="fw-bold text-dark fs-4">Esperando Consulta</h3>
                <p class="small">Seleccione una consulta en el panel lateral o<br>use el <b>Asistente IA</b>.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- CHAT MODAL (Bot贸n Flotante) -->
<button class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center" 
        style="position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1050; transition: transform 0.2s;"
        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'"
        data-bs-toggle="modal" data-bs-target="#aiModal">
    <i class="fa-solid fa-robot fa-xl"></i>
</button>

<!-- MODAL CHAT IA -->
<div class="modal fade" id="aiModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-lg">
        <div class="modal-content border-0 shadow-lg" style="height: 85vh;">
            <!-- Header -->
            <div class="modal-header bg-dark text-white py-2">
                <div class="d-flex align-items-center">
                    <i class="fa-solid fa-brain me-2 text-info"></i>
                    <h5 class="modal-title fw-bold fs-6">Asistente Industrial</h5>
                </div>
                <div class="ms-auto d-flex gap-2">
                    <button class="btn btn-sm btn-outline-secondary text-white" type="button" data-bs-toggle="collapse" data-bs-target="#configPanel">
                        <i class="fa-solid fa-gear"></i> Config
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <!-- Config IA -->
            <div class="collapse bg-light border-bottom p-3" id="configPanel">
                <div class="row g-2">
                    <div class="col-12 mb-2">
                        <label class="form-label fw-bold small text-secondary">PROVEEDOR</label>
                        <select id="aiProviderSelect" class="form-select form-select-sm" onchange="updateProviderSettings()">
                            <option value="openai">OpenAI (GPT-4o)</option>
                            <option value="groq">Groq (Llama3)</option>
                            <option value="ollama">Ollama (Local)</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">BASE URL</label>
                        <input type="text" id="aiBaseUrl" class="form-control form-control-sm font-monospace" placeholder="https://api.openai.com/v1/chat/completions">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold small text-secondary">MODELO</label>
                        <input type="text" id="aiModelName" class="form-control form-control-sm font-monospace" placeholder="gpt-4o">
                    </div>
                    <div class="col-12">
                        <label class="form-label fw-bold small text-secondary">API KEY</label>
                        <div class="input-group input-group-sm">
                            <input type="password" id="aiApiKey" class="form-control" placeholder="sk-...">
                            <button class="btn btn-primary" onclick="saveAiConfig()">Guardar</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Chat Body -->
            <div class="modal-body bg-light d-flex flex-column p-0">
                <div id="chatArea" class="flex-grow-1 overflow-auto p-3">
                    <div class="d-flex align-items-start mb-3">
                        <div class="bg-white text-dark border rounded p-3 shadow-sm" style="max-width: 85%;">
                            <div class="fw-bold small text-primary mb-1"><i class="fa-solid fa-robot me-1"></i> Sistema</div>
                            Hola. Soy tu asistente conectado al grafo industrial.
                        </div>
                    </div>
                </div>
            </div>
            <!-- Chat Input -->
            <div class="modal-footer p-2 bg-white border-top">
                <div class="input-group">
                    <input type="text" id="userPrompt" class="form-control border-0 bg-light" placeholder="Escribe aqu铆..." onkeypress="handleEnter(event)">
                    <button class="btn btn-primary px-4" onclick="sendPrompt()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- OFF CANVAS DETALLE NODO -->
<div class="offcanvas offcanvas-end shadow" tabindex="-1" id="nodeOffcanvas" data-bs-backdrop="false">
    <div class="offcanvas-header bg-primary text-white">
        <h5 id="offcanvasRightLabel" class="fw-bold"><i class="fa-solid fa-circle-info me-2"></i>Detalle del Nodo</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
        <div class="text-center mb-4">
            <div class="display-6 mb-2 text-primary"><i class="fa-solid fa-cube"></i></div>
            <h5 id="canvasNodeLabel" class="fw-bold text-break"></h5>
            <span id="canvasNodeType" class="badge bg-secondary fs-6"></span>
        </div>
        <div class="card bg-light border-0 mb-4">
            <div class="card-body">
                <label class="small text-muted fw-bold text-uppercase">Identificador nico</label>
                <div class="d-flex align-items-center gap-2">
                    <code id="canvasNodeId" class="fs-5 fw-bold text-dark text-break"></code>
                    <button class="btn btn-sm btn-outline-secondary" onclick="navigator.clipboard.writeText(document.getElementById('canvasNodeId').innerText)"><i class="fa-regular fa-copy"></i></button>
                </div>
            </div>
        </div>
        <div class="d-grid gap-2">
            <button class="btn btn-primary py-2 fw-bold" onclick="setFocusFromCanvas()"><i class="fa-solid fa-crosshairs me-2"></i> Usar como Objetivo</button>
            <button class="btn btn-outline-dark py-2" data-bs-dismiss="offcanvas">Cerrar</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let tomSelectInstance;
    let network = null;
    let selectedNodeData = null; 

    document.addEventListener("DOMContentLoaded", function(){
        // 1. Inicializar TomSelect (CORREGIDO PARA EVITAR DUPLICADOS DE TEXTO)
        tomSelectInstance = new TomSelect("#select-param", {
            valueField: 'id',
            labelField: 'title',
            searchField: ['title', 'id'], 
            preload: 'focus', 
            placeholder: 'Escribe para buscar...',
            create: false, 
            maxItems: 1, // Fuerza selecci贸n 煤nica
            
            // Opciones clave para limpieza visual
            persist: false,          
            closeAfterSelect: true,
            
            load: function(query, callback) {
                fetch('/api/search?q=' + encodeURIComponent(query || ''))
                    .then(r => r.json())
                    .then(json => callback(json))
                    .catch(() => callback());
            },
            render: { 
                option: (item, escape) => `<div class="py-2 border-bottom"><span class="badge bg-secondary me-2">${escape(item.label || 'Nodo')}</span><span class="fw-bold">${escape(item.title)}</span></div>`,
                // CORRECCIN 1: Renderizado simplificado para evitar conflictos visuales en el input
                item: (item, escape) => `<div class="text-truncate">${escape(item.title)}</div>`
            },
            // CORRECCIN 1: Forzar limpieza del texto de b煤squeda al seleccionar
            onItemAdd: function() {
                this.setTextboxValue(''); 
                this.refreshOptions(false);
            },
            onDelete: function(values) {
                return confirm('驴Borrar selecci贸n actual?');
            }
        });

        // 2. Cargar Config IA
        const savedConfig = localStorage.getItem("ai_config");
        if(savedConfig) {
            try {
                aiConfig = JSON.parse(savedConfig);
                const providerEl = document.getElementById('aiProviderSelect');
                if(providerEl) providerEl.value = aiConfig.provider || 'openai';
                document.getElementById('aiBaseUrl').value = aiConfig.baseUrl;
                document.getElementById('aiModelName').value = aiConfig.model;
                document.getElementById('aiApiKey').value = aiConfig.key;
            } catch(e) { console.error(e); }
        }
        loadTools();

        // 3. Restaurar UI
        {% if current_query %}
            const activeRadio = document.querySelector('input[name="query_id"][value="{{ current_query }}"]');
            if(activeRadio) new bootstrap.Collapse(activeRadio.closest('.accordion-collapse'), { toggle: true });
        {% endif %}
        
        // 4. Restaurar selecci贸n previa
        {% if current_param and current_param != "" %}
            setTimeout(() => {
                updateSearchParam("{{ current_param }}", "{{ current_param_label }}");
            }, 50);
        {% endif %}
    });

    // ---- FUNCIN DE SELECCIN ROBUSTA ----
    function updateSearchParam(id, label) {
        if (!tomSelectInstance) return;

        // Limpiar estado
        tomSelectInstance.clear(true);
        tomSelectInstance.clearOptions();

        // Inyectar opci贸n
        const safeLabel = label || id;
        tomSelectInstance.addOption({
            id: id,
            title: safeLabel, 
            label: 'Selecci贸n'
        });

        // Refrescar y Seleccionar
        tomSelectInstance.refreshOptions(false);
        tomSelectInstance.setValue(id); 
        tomSelectInstance.setTextboxValue('');

        // Feedback Visual
        const badge = document.getElementById('target-badge');
        if(badge) {
            badge.style.display = 'inline-block';
            setTimeout(() => badge.style.display = 'none', 1500);
        }
        
        // UX M贸vil
        if (window.innerWidth < 992) {
            const sidebar = new bootstrap.Offcanvas(document.getElementById('sidebarOffcanvas'));
            sidebar.show();
        }
    }

    function setFocusFromCanvas() { 
        if (selectedNodeData) updateSearchParam(selectedNodeData.id, selectedNodeData.fullLabel);
    }

    // ---- IA & TOOLS ----
    const PROVIDERS = { openai: { url: "https://api.openai.com/v1/chat/completions", model: "gpt-4o" }, groq: { url: "https://api.groq.com/openai/v1/chat/completions", model: "llama3-70b-8192" }, ollama: { url: "http://localhost:11434/v1/chat/completions", model: "llama3" } };
    let aiConfig = { provider: 'openai', baseUrl: PROVIDERS.openai.url, model: PROVIDERS.openai.model, key: '' };
    let chatHistory = [{role: "system", content: "Eres un experto."}];
    let availableTools = null;

    function updateProviderSettings() {
        const p = document.getElementById('aiProviderSelect').value;
        if(PROVIDERS[p]) { document.getElementById('aiBaseUrl').value = PROVIDERS[p].url; document.getElementById('aiModelName').value = PROVIDERS[p].model; }
    }
    function triggerAiTool(name, id) {
        new bootstrap.Modal(document.getElementById('aiModal')).show();
        let ctx = "";
        if(tomSelectInstance.getValue()) ctx = ` sobre "${tomSelectInstance.getValue()}"`;
        document.getElementById('userPrompt').value = `Usa "${name}"${ctx} y explica.`;
    }
    function saveAiConfig() {
        aiConfig = { provider: document.getElementById('aiProviderSelect').value, baseUrl: document.getElementById('aiBaseUrl').value, model: document.getElementById('aiModelName').value, key: document.getElementById('aiApiKey').value };
        localStorage.setItem("ai_config", JSON.stringify(aiConfig));
        bootstrap.Collapse.getInstance(document.getElementById('configPanel'))?.hide();
    }
    function loadTools() { if(!availableTools) fetch('/api/ai/tools').then(r=>r.json()).then(d=>availableTools=d); }
    function handleEnter(e) { if(e.key==='Enter') sendPrompt(); }
    
    async function sendPrompt() {
        const inp = document.getElementById('userPrompt');
        if(!inp.value.trim()) return;
        appendMessage('user', inp.value); chatHistory.push({role:'user', content:inp.value}); inp.value='';
        const tid = showTyping();
        try {
            const res = await fetch("/api/openai_proxy", { method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${aiConfig.key}`,"x-base-url":aiConfig.baseUrl}, body:JSON.stringify({model:aiConfig.model, messages:chatHistory, tools:availableTools})});
            const data = await res.json();
            if(data.error) throw new Error(JSON.stringify(data.error));
            const msg = data.choices[0].message; chatHistory.push(msg); removeTyping(tid);
            
            if(msg.tool_calls) {
                appendMessage('assistant', '<i> Ejecutando...</i>', true);
                for(const tc of msg.tool_calls) {
                    let args = {}; try { args=JSON.parse(tc.function.arguments); } catch(e){}
                    const tRes = await fetch('/api/execute', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({query_id:tc.function.name, param:args.param})});
                    const tData = await tRes.json();
                    chatHistory.push({role:'tool', tool_call_id:tc.id, name:tc.function.name, content:JSON.stringify(tData).slice(0, 2000)});
                }
                showTyping();
                const res2 = await fetch("/api/openai_proxy", { method:"POST", headers:{"Content-Type":"application/json","Authorization":`Bearer ${aiConfig.key}`,"x-base-url":aiConfig.baseUrl}, body:JSON.stringify({model:aiConfig.model, messages:chatHistory})});
                const data2 = await res2.json();
                removeTyping();
                appendMessage('assistant', data2.choices[0].message.content);
                chatHistory.push(data2.choices[0].message);
            } else { appendMessage('assistant', msg.content); }
        } catch(e) { removeTyping(); appendMessage('system', "Error: "+e.message); }
    }
    
    function appendMessage(role, text, temp) {
        const div = document.createElement('div');
        div.className = `d-flex align-items-start mb-3 ${role==='user'?'justify-content-end':''}`;
        div.innerHTML = `<div class="${role==='user'?'bg-primary text-white':'bg-white border'} rounded p-3 shadow-sm" style="max-width:85%;">${text}</div>`;
        document.getElementById('chatArea').append(div);
    }
    function showTyping() { const id='t-'+Date.now(); appendMessage('system', '<div id="'+id+'">...</div>'); return id; }
    function removeTyping(id) { if(id) document.getElementById(id)?.parentElement?.parentElement?.remove(); }

    // =========================================================
    // 1. FUNCIONALIDAD EXPORTAR CSV (TABLA)
    // =========================================================
    function exportCSV() {
        // Verificamos si hay datos disponibles (inyectados por Tera)
        if (typeof rows === 'undefined' || !rows || rows.length === 0) {
            alert("No hay datos en la tabla para exportar.");
            return;
        }

        // 1. Crear cabeceras
        // Usamos 'cols' que ya tienes definido en el template
        const headers = cols.join(",");

        // 2. Crear cuerpo del CSV
        const csvRows = rows.map(row => {
            return cols.map(colName => {
                // Obtenemos el valor, manejamos nulos
                let cell = row[colName] === null || row[colName] === undefined ? "" : String(row[colName]);
                
                // Escapamos comillas dobles (reemplazar " por "") y envolvemos en comillas
                // Esto es necesario si el texto contiene comas
                cell = cell.replace(/"/g, '""');
                return `"${cell}"`;
            }).join(",");
        });

        // 3. Unir todo con saltos de l铆nea
        const csvContent = [headers, ...csvRows].join("\r\n");

        // 4. Crear Blob y descargar
        // \uFEFF es el BOM para que Excel reconozca UTF-8 correctamente
        const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `nexus_export_${new Date().toISOString().slice(0,10)}.csv`);
        document.body.appendChild(link);
        
        link.click();
        
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // =========================================================
    // 2. FUNCIONALIDAD EXPORTAR PNG (GRAFO VIS.JS)
    // =========================================================
    function downloadGraphPNG() {
        // Verificamos si la red existe
        if (!network) {
            alert("No se ha generado ning煤n grafo visual para exportar.");
            return;
        }

        // Vis.js dibuja en un canvas HTML5 est谩ndar
        // Necesitamos esperar a que termine de dibujar por seguridad, 
        // aunque el onclick suele ser post-render.
        
        // Obtenemos el canvas espec铆fico dentro del contenedor
        const canvasContext = document.getElementById('network-container').getElementsByTagName('canvas')[0];
        
        if (!canvasContext) {
            alert("Error al obtener el lienzo del grafo.");
            return;
        }

        // TRUCO: Los canvas de Vis.js suelen tener fondo transparente.
        // Si lo descargas directamente, se ver谩 negro en muchos visores.
        // Creamos un canvas temporal para ponerle fondo blanco.
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = canvasContext.width;
        tempCanvas.height = canvasContext.height;
        const ctx = tempCanvas.getContext('2d');

        // 1. Rellenar fondo blanco
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);

        // 2. Dibujar el grafo encima
        ctx.drawImage(canvasContext, 0, 0);

        // 3. Generar enlace de descarga
        try {
            const imageUrl = tempCanvas.toDataURL("image/png");
            
            const link = document.createElement('a');
            link.download = `nexus_graph_${new Date().toISOString().slice(0,19).replace(/:/g,"-")}.png`;
            link.href = imageUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch (err) {
            console.error(err);
            alert("Error al generar la imagen. Es posible que el navegador bloquee descargas de canvas muy grandes.");
        }
    }

    // ---- RENDERIZADO VISUAL ----
    {% if results %}
        const rows = {{ results.rows | json_encode() | safe }};
        const cols = {{ results.columns | json_encode() | safe }};
        const isGraphQuery = {{ results.is_graph | json_encode() }};
        
        // ChartJS
        const numCol = cols.find(c => ['CANTIDAD','TOTAL','SCORE','PRECIO'].some(k => c.includes(k)));
        const lblCol = cols.find(c => ['DESCRIPCION','NAME','EQUIPO'].some(k => c.includes(k))) || cols[0];
        if (numCol && rows.length) {
            new Chart(document.getElementById('mainChart').getContext('2d'), {
                type: 'bar',
                data: { labels: rows.map(r=>r[lblCol].substring(0,20)), datasets: [{ label: numCol, data: rows.map(r=>parseFloat(r[numCol])||0), backgroundColor: '#3498db' }] },
                options: { maintainAspectRatio: false }
            });
        }

        // VisJS
        if (cols.includes('A_ID') && cols.includes('B_ID') && isGraphQuery) {
            const nodes = new Map(), edges = [];
            rows.forEach(r => {
                if(!nodes.has(r.A_ID)) nodes.set(r.A_ID, {id:r.A_ID, label:r.A_LABEL, group:r.A_TYPE});
                if(!nodes.has(r.B_ID)) nodes.set(r.B_ID, {id:r.B_ID, label:r.B_LABEL, group:r.B_TYPE});
                edges.push({from:r.A_ID, to:r.B_ID, label:r.RELACION, arrows:'to'});
            });
            network = new vis.Network(document.getElementById('network-container'), {
                nodes: new vis.DataSet(Array.from(nodes.values())), edges: new vis.DataSet(edges)
            }, {
                nodes: { shape: 'dot', font: { size: 14, face: 'Outfit' } },
                groups: { Material: { color:{background:'#f1c40f'} }, Equipo: { color:{background:'#3498db'} } }
            });
            
            network.on("click", p => {
                if(p.nodes.length) {
                    const n = nodes.get(p.nodes[0]);
                    selectedNodeData = n;
                    document.getElementById('canvasNodeLabel').innerText = n.label;
                    document.getElementById('canvasNodeId').innerText = n.id;
                    new bootstrap.Offcanvas(document.getElementById('nodeOffcanvas')).show();
                    updateSearchParam(n.id, n.label);
                }
            });
        }
    {% endif %}
</script>
{% endblock %}